<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Chassis Management System</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        /* Color Palette (Inspired by Limitless template) */
        :root {
            --sidebar-bg: #212837;
            --header-bg: #2d3544;
            --main-bg: #f0f2f5;
            --card-bg: #ffffff;
            --text-dark: #333333;
            --text-light: #e0e0e0;
            --text-muted: #6c757d;
            --accent-blue: #007bff; /* Primary blue */
            --accent-green: #28a745; /* Success green */
            --accent-red: #dc3545; /* Danger red */
            --accent-orange: #ffc107; /* Warning orange */
            --border-color: #e9ecef;
            --nav-item-hover: #343b4c;
            --nav-item-active: #007bff;
            --nav-text-color: #aeb8c2;
            --nav-text-active: #ffffff;
            --input-bg: #f8f9fa;
            --input-border: #ced4da;
            --shadow-light: rgba(0, 0, 0, 0.1);
            --shadow-medium: rgba(0, 0, 0, 0.2);
        }

        /* Global Styles */
        body {
            font-family: 'Inter', sans-serif;
            margin: 0;
            padding: 0;
            background-color: var(--main-bg);
            color: var(--text-dark);
            display: flex;
            min-height: 100vh;
            box-sizing: border-box;
            font-size: 14px;
            overflow: hidden; /* Prevent body scroll */
        }

        /* Subtle transition for all elements for smooth interactions */
        * {
            transition: all 0.2s ease-in-out;
        }

        /* App Wrapper for main layout (sidebar + content) */
        #app-wrapper {
            display: flex;
            width: 100%;
            height: 100vh; /* Full viewport height */
            overflow: hidden;
        }

        /* Sidebar Styling */
        #sidebar {
            width: 250px;
            background-color: var(--sidebar-bg);
            color: var(--nav-text-color);
            padding: 20px 0;
            display: flex;
            flex-direction: column;
            box-shadow: 2px 0 5px var(--shadow-light);
            flex-shrink: 0; /* Prevent shrinking */
            overflow-y: auto; /* Allow scrolling for long navs */
        }

        #sidebar .logo {
            text-align: center;
            margin-bottom: 30px;
            font-size: 24px;
            font-weight: 700;
            color: var(--nav-text-active);
            text-transform: uppercase;
        }

        #sidebar .user-profile {
            text-align: center;
            padding: 15px 0;
            margin-bottom: 20px;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }
        #sidebar .user-profile img {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            object-fit: cover;
            margin-bottom: 10px;
            border: 2px solid var(--accent-blue);
        }
        #sidebar .user-profile p {
            margin: 0;
            font-weight: 600;
            color: var(--nav-text-active);
        }
        #sidebar .user-profile span {
            font-size: 12px;
            color: var(--nav-text-color);
        }


        #sidebar #navigation {
            display: flex;
            flex-direction: column;
            gap: 5px;
            padding: 0 15px;
        }

        #sidebar #navigation button {
            background-color: transparent;
            border: none;
            color: var(--nav-text-color);
            padding: 12px 15px;
            text-align: left;
            font-size: 15px;
            font-weight: 500;
            border-radius: 5px;
            cursor: pointer;
            transition: background-color 0.2s ease, color 0.2s ease;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        #sidebar #navigation button:hover {
            background-color: var(--nav-item-hover);
            color: var(--nav-text-active);
        }

        #sidebar #navigation button.active-nav {
            background-color: var(--nav-item-active);
            color: var(--nav-text-active);
            font-weight: 600;
        }

        /* Content Wrapper (Header + Main Content) */
        #content-wrapper {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            overflow-y: auto; /* Allow content to scroll */
        }

        /* Header Styling */
        #header {
            background-color: var(--header-bg);
            color: var(--text-light);
            padding: 15px 25px;
            box-shadow: 0 2px 5px var(--shadow-light);
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-shrink: 0; /* Prevent shrinking */
        }

        #header .header-left h1 {
            margin: 0;
            font-size: 20px;
            color: var(--nav-text-active);
        }
        #header .header-left #company-name {
            font-size: 12px;
            color: var(--nav-text-color);
            margin-bottom: 5px;
        }

        #header .header-right {
            display: flex;
            align-items: center;
            gap: 20px;
        }
        #header .header-right #logged-in-user {
            font-size: 14px;
            color: var(--nav-text-color);
        }
        #header .header-right .header-user-info {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        #header .header-right .header-user-info img {
            width: 35px;
            height: 35px;
            border-radius: 50%;
            object-fit: cover;
            border: 1px solid rgba(255,255,255,0.3);
        }
        #header .header-right .header-user-info button {
            background-color: transparent;
            border: 1px solid var(--nav-text-color);
            color: var(--nav-text-color);
            padding: 8px 15px;
            border-radius: 5px;
            cursor: pointer;
            font-weight: 500;
        }
        #header .header-right .header-user-info button:hover {
            background-color: var(--nav-item-hover);
            color: var(--nav-text-active);
        }


        /* Main Content Area */
        #main-content {
            flex-grow: 1;
            padding: 25px;
            background-color: var(--main-bg);
            overflow-y: auto; /* Allow content to scroll */
        }

        /* Login Container Styling */
        #login-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: #1a1a2e; /* Deep blue-purple background */
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            flex-direction: column;
        }

        #login-container .login-box {
            background-color: var(--card-bg);
            padding: 30px 40px;
            border-radius: 8px;
            box-shadow: 0 5px 15px var(--shadow-medium);
            text-align: center;
            width: 100%;
            max-width: 400px;
            color: var(--text-dark);
        }

        #login-container h2 {
            color: var(--accent-blue);
            margin-bottom: 25px;
            font-size: 2em;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.1);
        }

        /* View Styling */
        .view {
            display: none;
            background-color: var(--card-bg);
            padding: 25px;
            border-radius: 8px;
            box-shadow: 0 2px 8px var(--shadow-light);
            margin-bottom: 25px;
            color: var(--text-dark);
        }

        .view.active {
            display: block;
        }

        .view h2 {
            color: var(--accent-blue);
            margin-top: 0;
            margin-bottom: 20px;
            font-size: 1.8em;
            border-bottom: 1px solid var(--border-color);
            padding-bottom: 10px;
        }

        /* Form Group Styling */
        .form-group {
            margin-bottom: 15px;
            text-align: left;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: var(--text-dark);
        }

        .form-group input[type="text"],
        .form-group input[type="number"],
        .form-group input[type="date"],
        .form-group input[type="password"],
        .form-group textarea,
        .form-group select {
            width: calc(100% - 22px); /* Account for padding and border */
            padding: 10px;
            border: 1px solid var(--input-border);
            border-radius: 5px;
            box-sizing: border-box;
            background-color: var(--input-bg);
            color: var(--text-dark);
            font-size: 14px;
        }

        .form-group input[type="text"]:focus,
        .form-group input[type="number"]:focus,
        .form-group input[type="date"]:focus,
        .form-group input[type="password"]:focus,
        .form-group textarea:focus,
        .form-group select:focus {
            border-color: var(--accent-blue);
            outline: none;
            box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.25);
        }

        /* Checkbox styling */
        .form-group .checkbox-group {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
        }

        .form-group .checkbox-group input[type="checkbox"] {
            width: auto;
            margin-right: 8px;
            transform: scale(1.2);
            cursor: pointer;
        }

        .form-group .checkbox-group label {
            display: inline;
            margin-bottom: 0;
            font-weight: 400;
            cursor: pointer;
        }


        /* File Input Styling */
        input[type="file"] {
            display: none;
        }

        .custom-file-upload {
            display: inline-block;
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            background-color: var(--accent-green);
            color: white;
            cursor: pointer;
            font-weight: 600;
            box-shadow: 0 2px 5px var(--shadow-light);
            margin: 8px 0;
        }

        .custom-file-upload:hover {
            background-color: #218838; /* Darker green */
        }

        /* General Button Styling */
        button {
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            background-color: var(--accent-blue);
            color: white;
            cursor: pointer;
            font-weight: 600;
            transition: background-color 0.2s ease, transform 0.1s ease, box-shadow 0.2s ease;
            margin: 5px;
            box-shadow: 0 2px 5px var(--shadow-light);
        }

        button:hover {
            background-color: #0056b3; /* Darker blue */
            transform: translateY(-1px);
            box-shadow: 0 4px 8px var(--shadow-medium);
        }

        /* Specific Button Styles */
        button.delete-btn {
            background-color: var(--accent-red);
        }
        button.delete-btn:hover {
            background-color: #c82333;
        }

        button.generate-doc-btn {
            background-color: var(--accent-green);
        }
        button.generate-doc-btn:hover {
            background-color: #218838;
        }

        button.edit-btn {
            background-color: var(--accent-orange);
            color: var(--text-dark);
        }
        button.edit-btn:hover {
            background-color: #e0a800;
        }

        /* Data Table Styling */
        .data-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            font-size: 13px;
            background-color: var(--card-bg);
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 8px var(--shadow-light);
        }

        .data-table th, .data-table td {
            border: 1px solid var(--border-color);
            padding: 10px;
            text-align: left;
        }

        .data-table th {
            background-color: var(--accent-blue);
            color: white;
            font-weight: 600;
            text-transform: uppercase;
        }

        .data-table tbody tr:nth-child(even) {
            background-color: #f8f9fa;
        }
        .data-table tbody tr:hover {
            background-color: #e2e6ea;
        }

        /* Message Box Styling */
        #message-box {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background-color: var(--accent-green);
            color: white;
            padding: 15px 25px;
            border-radius: 5px;
            box-shadow: 0 4px 12px var(--shadow-medium);
            z-index: 1000;
            opacity: 1;
            transition: opacity 0.5s ease-in-out, top 0.5s ease-in-out;
            white-space: nowrap;
            max-width: 90%;
            text-align: center;
            font-weight: 600;
        }

        #message-box.error {
            background-color: var(--accent-red);
        }

        #message-box.hidden {
            opacity: 0;
            top: -60px;
        }

        /* Confirmation Box */
        #confirmation-box {
            background-color: var(--card-bg) !important;
            color: var(--text-dark) !important;
            border: 1px solid var(--border-color) !important;
            box-shadow: 0 5px 15px var(--shadow-medium) !important;
        }
        #confirmation-box p {
            color: var(--text-dark) !important;
        }
        #confirmation-box button {
            margin: 5px;
        }

        /* Inventory View Specific Styles */
        .inventory-counts {
            margin-bottom: 15px;
            font-size: 1.1em;
            color: var(--text-dark);
        }

        .inventory-counts span {
            font-weight: bold;
            color: var(--accent-blue);
            font-size: 1.2em;
        }

        #billOfLadingBreakdown {
            margin-top: 20px;
            border-top: 1px solid var(--border-color);
            padding-top: 15px;
            text-align: left;
        }

        #billOfLadingBreakdown h3 {
            color: var(--accent-blue);
            margin-bottom: 10px;
            font-size: 1.2em;
        }

        #billOfLadingBreakdown ul {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        #billOfLadingBreakdown li {
            margin-bottom: 8px;
            padding: 8px;
            background-color: #f8f9fa;
            border-radius: 5px;
            border: 1px solid var(--border-color);
            font-size: 0.9em;
            color: var(--text-dark);
        }

        #billOfLadingBreakdown li strong {
            color: var(--accent-blue);
        }

        /* Search Container Styling */
        .search-container {
            margin-bottom: 15px;
            display: flex;
            gap: 10px;
            align-items: center;
            flex-wrap: wrap;
        }

        .search-container input[type="text"] {
            flex-grow: 1;
            padding: 10px;
            border: 1px solid var(--input-border);
            border-radius: 5px;
            box-sizing: border-box;
            background-color: var(--input-bg);
            color: var(--text-dark);
        }

        .search-container button {
            padding: 10px 15px;
        }

        /* Dashboard Specific Styles */
        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .dashboard-card {
            background-color: var(--card-bg);
            padding: 20px;
            border-radius: 8px;
            border: 1px solid var(--border-color);
            box-shadow: 0 2px 8px var(--shadow-light);
            text-align: center;
        }

        .dashboard-card h3 {
            color: var(--accent-blue);
            margin-top: 0;
            font-size: 1.2em;
            margin-bottom: 10px;
        }

        .dashboard-card p {
            font-size: 2em;
            font-weight: bold;
            color: var(--text-dark);
            margin: 10px 0 0;
        }
        .dashboard-card .description {
            font-size: 0.85em;
            color: var(--text-muted);
            margin-top: 5px;
        }

        #dashboard-recent-activity {
            list-style: none;
            padding: 0;
            margin: 15px 0 0;
            font-size: 0.9em;
            text-align: left;
        }

        #dashboard-recent-activity li {
            background-color: #f8f9fa;
            padding: 8px 12px;
            border-radius: 5px;
            margin-bottom: 5px;
            border: 1px solid var(--border-color);
        }

        /* Chassis Yard Visualization */
        #chassisYardCanvas {
            background-color: #eceff1;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            display: block;
            margin: 20px auto 0;
            touch-action: manipulation;
            width: 100%;
            box-shadow: 0 2px 8px var(--shadow-light);
        }

        #chassis-details-box {
            background-color: var(--card-bg);
            border: 1px solid var(--accent-blue);
            border-radius: 8px;
            padding: 20px;
            margin-top: 20px;
            text-align: left;
            box-shadow: 0 2px 8px var(--shadow-light);
            display: none;
            max-width: 100%;
            overflow-x: auto;
            color: var(--text-dark);
        }

        #chassis-details-box h3 {
            color: var(--accent-blue);
            margin-top: 0;
            margin-bottom: 15px;
            font-size: 1.3em;
        }

        #chassis-details-box p {
            margin-bottom: 8px;
            color: var(--text-dark);
            word-wrap: break-word;
        }

        #chassis-details-box p strong {
            color: var(--accent-blue);
        }

        /* Dashboard Charts Section */
        .dashboard-charts {
            margin-top: 30px;
            padding-top: 20px;
            border-top: 1px solid var(--border-color);
            text-align: center;
        }

        .dashboard-charts h2 {
            color: var(--accent-blue);
            margin-bottom: 20px;
            font-size: 1.6em;
        }

        .chart-container {
            background-color: var(--card-bg);
            padding: 20px;
            border-radius: 8px;
            border: 1px solid var(--border-color);
            box-shadow: 0 2px 8px var(--shadow-light);
            margin-bottom: 20px;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 300px;
        }

        .chart-container canvas {
            max-width: 100%;
            max-height: 100%;
        }

        /* Invoice/Packing List/Waybill Item Rows */
        .invoice-item-row, .packing-list-item-row, .waybill-item-row {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 10px;
            align-items: flex-end;
        }

        .invoice-item-row input, .packing-list-item-row input, .waybill-item-row input {
            flex: 1;
            min-width: 80px;
        }
        /* Specific widths for invoice items */
        .invoice-item-row .item-chassis-number { flex: 2; min-width: 120px; }
        .invoice-item-row .item-description { flex: 3; min-width: 180px; }
        .invoice-item-row .item-qty { flex: 0.8; min-width: 50px; }
        .invoice-item-row .item-volume { flex: 1; min-width: 70px; }
        .invoice-item-row .item-unit-price { flex: 1.5; min-width: 90px; }
        .invoice-item-row .item-total-price { flex: 1.5; min-width: 90px; }
        .invoice-item-row .remove-item-btn { flex: 0.3; min-width: 30px; }

        /* Specific widths for packing list items */
        .packing-list-item-row .pl-item-chassis-number { flex: 2; min-width: 120px; }
        .packing-list-item-row .pl-item-description { flex: 3; min-width: 180px; }
        .packing-list-item-row .pl-item-qty { flex: 0.8; min-width: 50px; }
        .packing-list-item-row .pl-item-volume { flex: 1; min-width: 70px; }
        .packing-list-item-row .pl-item-net-weight { flex: 1; min-width: 70px; }
        .packing-list-item-row .pl-item-gross-weight { flex: 1; min-width: 70px; }
        .packing-list-item-row .pl-item-manufacture-year { flex: 1; min-width: 70px; }
        .packing-list-item-row .remove-pl-item-btn { flex: 0.3; min-width: 30px; }

        /* Specific widths for waybill items */
        .waybill-item-row .wb-item-description { flex: 3; min-width: 180px; }
        .waybill-item-row .wb-item-qty { flex: 0.8; min-width: 50px; }
        .waybill-item-row .wb-item-chassis-engine { flex: 2; min-width: 120px; }
        .waybill-item-row .wb-item-gross-weight { flex: 1.5; min-width: 90px; }
        .waybill-item-row .wb-item-measurement { flex: 1.5; min-width: 90px; }
        .waybill-item-row .remove-wb-item-btn { flex: 0.3; min-width: 30px; }


        /* Responsive styles for smaller screens */
        @media (max-width: 768px) {
            #sidebar {
                width: 0;
                padding: 0;
                overflow: hidden;
                position: absolute;
                height: 100vh;
                z-index: 999;
                transition: width 0.3s ease;
            }
            #sidebar.open {
                width: 250px;
                padding: 20px 0;
            }
            #header {
                padding: 10px 15px;
            }
            #header .header-left h1 {
                font-size: 18px;
            }
            #header .header-left #company-name {
                display: none;
            }
            #header .header-right {
                gap: 10px;
            }
            #header .header-right #logged-in-user {
                display: none;
            }
            #main-content {
                padding: 15px;
            }
            .view {
                padding: 15px;
            }
            .view h2 {
                font-size: 1.5em;
            }
            .dashboard-grid {
                grid-template-columns: 1fr;
            }
            .invoice-item-row, .packing-list-item-row, .waybill-item-row {
                flex-direction: column;
                align-items: stretch;
            }
            .invoice-item-row input, .packing-list-item-row input, .waybill-item-row input {
                width: 100%;
                min-width: unset;
            }
            .invoice-item-row .remove-item-btn,
            .packing-list-item-row .remove-pl-item-btn,
            .waybill-item-row .remove-wb-item-btn {
                width: 100%;
                margin-top: 5px;
            }
            .search-container {
                flex-direction: column;
                gap: 8px;
            }
            .search-container input[type="text"], .search-container button {
                 width: 100%;
            }
        }

        /* Print styles to retain color and improve layout for PDF */
        @media print {
            body {
                margin: 0;
                background-color: #fff !important;
                -webkit-print-color-adjust: exact;
                print-color-adjust: exact;
                font-size: 9pt !important; /* Reduced base font size for all documents */
                color: #000 !important;
                overflow: visible !important;
            }
            #app-wrapper {
                display: block !important;
                height: auto !important;
                overflow: visible !important;
            }
            #sidebar, #header, #login-container, #message-box {
                display: none !important;
            }
            #content-wrapper {
                margin-left: 0 !important;
                height: auto !important;
                overflow: visible !important;
            }
            #main-content {
                padding: 0 !important;
                background-color: #fff !important;
                box-shadow: none !important;
                overflow: visible !important;
            }

            /* Hide all views by default except those explicitly shown for print */
            .view:not(#history-view):not(#invoicing-view):not(#packing-list-view):not(#truck-waybill-view) {
                display: none !important;
            }

            /* Ensure specific views are visible for printing when requested */
            #history-view, #invoices-list-container, #packing-lists-list-container, #waybills-list-container,
            #invoicing-view.active, #packing-list-view.active, #truck-waybill-view.active {
                display: block !important;
                padding-top: 0 !important;
                background-color: #fff !important;
                box-shadow: none !important;
            }

            /* Print-specific table styles */
            .data-table {
                width: 100% !important;
                font-size: 8.5pt !important; /* Slightly reduced for data tables */
                color: #000 !important;
                border-collapse: collapse;
            }

            .data-table th, .data-table td {
                border: 1px solid #666 !important; /* Darker border for print */
                padding: 5px !important; /* Reduced padding */
                text-align: left;
            }

            .data-table th {
                background-color: var(--accent-blue) !important;
                color: white !important;
                font-weight: 600 !important;
            }

            .data-table tbody tr:nth-child(even) {
                background-color: #f0f0f0 !important; /* Light grey for even rows */
            }
             .data-table tbody tr:nth-child(odd) {
                background-color: #fff !important;
            }

            .admin-only {
                display: none !important;
            }

            /* Specific styling for generated documents (invoice, packing list, waybill) */
            .document-print-container { /* Added a class for the generated print content */
                width: 210mm; /* A4 width */
                min-height: 297mm; /* A4 height */
                margin: 0 auto;
                padding: 8mm 12mm; /* Reduced padding for professional look */
                box-sizing: border-box;
                color: #000;
                font-size: 9pt; /* Base font size for generated documents */
            }

            .document-print-container .header {
                text-align: center;
                margin-bottom: 6mm; /* Reduced margin */
            }
            .document-print-container .header p:first-child {
                color: #003366 !important;
                font-size: 1.1em !important; /* Slightly reduced */
                font-weight: bold !important;
                margin-bottom: 1.5mm !important;
            }
            .document-print-container .header p {
                color: #333 !important;
                font-size: 0.8em !important; /* Reduced */
                margin: 0.4mm 0 !important;
            }
            .document-print-container .header h1 {
                color: #003366 !important;
                font-size: 1.6em !important; /* Reduced */
                margin: 4mm 0 3mm 0 !important; /* Reduced margin */
                text-transform: uppercase;
                border-bottom: 2px solid #003366; /* Underline effect */
                padding-bottom: 2.5mm; /* Reduced padding */
            }
            .document-print-container .header strong {
                font-size: 1em !important; /* Slightly reduced */
            }

            .document-print-container .details-table {
                width: 100% !important;
                border-collapse: collapse !important;
                margin-bottom: 5mm !important; /* Reduced margin */
                border: 1px solid #999 !important; /* Stronger border */
                font-size: 0.85em !important; /* Reduced */
            }
            .document-print-container .details-table td {
                padding: 3mm !important; /* Reduced padding */
                border: 1px solid #ddd !important;
                background-color: #f8f8f8 !important;
                box-sizing: border-box !important;
            }
            .document-print-container .details-table .label {
                background-color: #e6f3fa !important;
                color: #003366 !important;
                font-weight: bold !important;
                width: 120px !important; /* Consistent width, slightly reduced */
            }

            .document-print-container .item-table {
                width: 100% !important;
                border-collapse: collapse !important;
                margin-top: 5mm !important; /* Reduced margin */
                font-size: 0.85em !important; /* Reduced */
            }
            .document-print-container .item-table th, .document-print-container .item-table td {
                border: 1px solid #999 !important; /* Stronger border */
                padding: 3mm !important; /* Reduced padding */
                text-align: left !important;
                color: #000 !important;
                box-sizing: border-box !important;
            }
            .document-print-container .item-table th {
                background-color: #0056b3 !important;
                color: white !important;
                font-weight: bold !important;
            }
            .document-print-container .item-table tbody tr:nth-child(even) {
                background-color: #f0f0f0 !important;
            }
            .document-print-container .item-table tbody tr:nth-child(odd) {
                background-color: #ffffff !important;
            }

            /* Specific column width adjustments for print documents */
            /* Invoice/Packing List Item Table */
            .document-print-container .item-table th:nth-child(1), /* Marks & Numbers / Chassis Number */
            .document-print-container .item-table td:nth-child(1) {
                width: 25% !important;
                font-weight: bold !important;
            }
            .document-print-container .item-table th:nth-child(2), /* Description of Goods */
            .document-print-container .item-table td:nth-child(2) {
                width: 40% !important;
                font-weight: bold !important;
            }

            /* Waybill Item Table */
            .document-print-container .item-table th:nth-child(1), /* Description of Goods N/M */
            .document-print-container .item-table td:nth-child(1) {
                width: 35% !important;
                font-weight: bold !important;
            }
            .document-print-container .item-table th:nth-child(3), /* CHASSIS NO./ENGINE NO. */
            .document-print-container .item-table td:nth-child(3) {
                width: 25% !important;
                font-weight: bold !important;
            }


            .document-print-container .total-row {
                background-color: #cfe8ff !important;
                color: #000 !important;
                font-weight: bold !important;
            }
            .document-print-container .footer {
                margin-top: 10mm !important; /* Reduced margin */
                text-align: center !important;
                font-size: 0.75em !important; /* Reduced */
                color: #555 !important;
            }
            /* Specific details grid for waybill */
             .document-print-container .details-grid {
                grid-template-columns: 1fr 1fr !important;
                gap: 2.5mm 5mm !important; /* Reduced gap */
                margin-bottom: 5mm !important; /* Reduced margin */
                font-size: 0.85em !important; /* Reduced */
                display: grid !important;
            }
            .document-print-container .details-grid strong {
                display: block !important;
                margin-bottom: 1mm !important; /* Reduced margin */
                color: #003366 !important;
                font-size: 0.95em !important;
            }
            .document-print-container .details-item {
                border: 1px solid #c0c0c0 !important;
                padding: 2.5mm 4mm !important; /* Reduced padding */
                border-radius: 3px !important;
                background-color: #fcfcfc !important;
                box-sizing: border-box !important;
            }
            .document-print-container .details-item span { display: block !important; line-height: 1.3; } /* Reduced line-height */

            @page {
                size: A4 portrait;
                margin: 0;
            }
        }
    </style>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.17.0/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
    <div id="login-container">
        <div class="login-box">
            <h2>Chassis Management Login</h2>
            <form id="loginForm">
                <div class="form-group">
                    <label for="username">Username:</label>
                    <input type="text" id="username" required>
                </div>
                <div class="form-group">
                    <label for="password">Password:</label>
                    <input type="password" id="password" required>
                </div>
                <button type="submit">Login</button>
            </form>
        </div>
    </div>

    <div id="app-wrapper">
        <div id="sidebar">
            <div class="logo">HOJAFA</div>
            <div class="user-profile">
                <img src="https://placehold.co/60x60/cccccc/333333?text=MF" alt="User Avatar">
                <p>Mohamed Farah</p>
                <span>Senior developer</span>
            </div>
            <div id="navigation">
                <button id="nav-dashboard" class="active-nav">Dashboard</button>
                <button id="nav-checkin">Check-In</button>
                <button id="nav-checkout">Check-Out</button>
                <button id="nav-inventory">Inventory</button>
                <button id="nav-history">History</button>
                <button id="nav-invoicing">Invoicing</button>
                <button id="nav-packing-list">Packing List</button>
                <button id="nav-truck-waybill">Truck Waybill</button>
                <button id="nav-document-archive">Document Archive</button>
                <button id="nav-manage-users">Manage Users</button>
            </div>
        </div>

        <div id="content-wrapper">
            <div id="header">
                <div class="header-left">
                    <p id="company-name">HOJAFA AUTO LTD FZE</p>
                    <h1>Chassis Management System</h1>
                </div>
                <div class="header-right">
                    <div class="header-user-info">
                        <p id="logged-in-user"></p>
                        <img src="https://placehold.co/35x35/cccccc/333333?text=User" alt="User Avatar">
                        <button id="nav-logout">Logout</button>
                    </div>
                </div>
            </div>

            <div id="main-content">
                <div id="message-box" class="hidden"></div>

                <div id="dashboard-view" class="view active">
                    <h2>Dashboard Overview</h2>
                    <div class="dashboard-grid">
                        <div class="dashboard-card">
                            <h3>Total Chassis Checked In</h3>
                            <p id="dashboard-checked-in">0</p>
                            <span class="description">Currently in inventory</span>
                        </div>
                        <div class="dashboard-card">
                            <h3>Total Chassis Checked Out</h3>
                            <p id="dashboard-checked-out">0</p>
                            <span class="description">Released to customers</span>
                        </div>
                        <div class="dashboard-card">
                            <h3>Chassis In - Chassis Out</h3>
                            <p id="dashboard-available-chassis">0</p>
                            <span class="description">Net chassis count</span>
                        </div>
                        <div class="dashboard-card">
                            <h3>Total Invoices Generated</h3>
                            <p id="dashboard-invoices">0</p>
                            <span class="description">Completed invoices</span>
                        </div>
                        <div class="dashboard-card">
                            <h3>Total Packing Lists Generated</h3>
                            <p id="dashboard-packing-lists">0</p>
                            <span class="description">Prepared shipments</span>
                        </div>
                         <div class="dashboard-card">
                            <h3>Total Waybills Generated</h3>
                            <p id="dashboard-waybills">0</p>
                            <span class="description">Truck waybills issued</span>
                        </div>
                         <div class="dashboard-card">
                            <h3>Total Archived Documents</h3>
                            <p id="dashboard-archived-documents">0</p>
                            <span class="description">Documents stored (metadata)</span>
                        </div>
                        <div class="dashboard-card">
                            <h3>Recent Activity</h3>
                            <ul id="dashboard-recent-activity">
                                <li>No recent activity.</li>
                            </ul>
                        </div>
                    </div>

                    <div class="dashboard-charts">
                        <h2>Analytics & Graphs</h2>
                        <div class="chart-container">
                            <canvas id="chassisStatusChart"></canvas>
                        </div>
                        <div class="chart-container">
                            <canvas id="documentTypeChart"></canvas>
                        </div>
                    </div>
                </div>

                <div id="checkin-view" class="view">
                    <h2>Check-In Chassis</h2>
                    <form id="checkinForm" class="form">
                        <div class="form-group">
                            <label for="checkinChassisNumber">Chassis Number:</label>
                            <input type="text" id="checkinChassisNumber" name="checkinChassisNumber" required>
                        </div>
                         <div class="form-group">
                            <label for="checkinBillOfLading">Bill of Lading Number:</label>
                            <input type="text" id="checkinBillOfLading" name="checkinBillOfLading">
                        </div>
                         <div class="form-group">
                            <label for="checkinRemarque">Remarque:</label>
                            <textarea id="checkinRemarque" name="checkinRemarque" rows="3"></textarea>
                         </div>
                        <button type="submit">Check-In</button>
                    </form>
                </div>

                <div id="checkout-view" class="view">
                    <h2>Check-Out Chassis</h2>
                    <form id="checkoutForm" class="form">
                        <div class="form-group">
                            <label for="checkoutChassisNumber">Chassis Number:</label>
                            <input type="text" id="checkoutChassisNumber" name="checkoutChassisNumber" required>
                        </div>
                        <div class="form-group">
                            <label for="checkoutCustomerName">Customer Name:</label>
                            <input type="text" id="checkoutCustomerName" name="checkoutCustomerName" required>
                        </div>
                         <div class="form-group">
                            <label for="checkoutRemarque">Remarque:</label>
                            <textarea id="checkoutRemarque" name="checkoutRemarque" rows="3"></textarea>
                         </div>
                        <button type="submit">Check-Out</button>
                    </form>
                </div>

                <div id="inventory-view" class="view">
                    <h2>Current Inventory</h2>
                    <p class="inventory-counts">Total Checked In: <span id="totalCheckedIn">0</span></p>
                    <p class="inventory-counts">Total Checked Out: <span id="totalCheckedOut">0</span></p>

                    <div id="billOfLadingBreakdown">
                        <h3>Breakdown by Bill of Lading</h3>
                        <ul id="billOfLadingList">
                            </ul>
                    </div>

                    <!-- Integrated Chassis Yard Visualization Canvas -->
                    <canvas id="chassisYardCanvas"></canvas>
                    <div id="chassis-details-box">
                        <h3>Chassis Details</h3>
                        <p><strong>Chassis Number:</strong> <span id="detail-chassis-number"></span></p>
                        <p><strong>Status:</strong> <span id="detail-status"></span></p>
                        <p><strong>Customer:</strong> <span id="detail-customer"></span></p>
                        <p><strong>Bill of Lading:</strong> <span id="detail-bill-of-lading"></span></p>
                        <p><strong>Check-in Date:</strong> <span id="detail-checkin-date"></span></p>
                        <p><strong>Check-out Date:</strong> <span id="detail-checkout-date"></span></p>
                        <p><strong>Remarque:</strong> <span id="detail-remarque"></span></p>
                        <button id="close-details-btn">Close</button>
                    </div>
                </div>

                <div id="history-view" class="view">
                    <h2>Transaction History</h2>
                    <!-- NEW: Yard Summary Box in History -->
                    <div id="history-yard-summary" class="dashboard-card" style="margin-bottom: 20px; text-align: left; padding: 15px;">
                        <h3>Chassis In Yard Now</h3>
                        <p style="font-size: 1.5em; font-weight: bold; color: var(--accent-blue); margin: 5px 0;"><span id="history-in-yard-count">0</span> chassis</p>
                        <span class="description">Currently checked in. <a href="#" id="view-inventory-link" style="color: var(--accent-blue); text-decoration: underline;">View Inventory Yard</a></span>
                    </div>

                    <div style="margin-bottom: 15px; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 10px;">
                        <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                            <button id="exportHistory">Export to CSV</button>
                            <label for="importExcel" class="custom-file-upload">
                                Import from Excel
                            </label>
                            <input type="file" id="importExcel" accept=".xlsx, .xls">
                            <button id="printHistory">Print History</button>
                        </div>
                         <div class="search-container">
                            <input type="text" id="chassisSearchInput" placeholder="Search by Chassis, Bill of Lading, or Customer Name">
                            <button id="searchChassisButton">Search</button>
                        </div>
                    </div>

                    <table id="historyTable" class="data-table">
                        <thead>
                            <tr>
                                <th>Chassis Number</th>
                                <th>Status</th>
                                <th>Customer</th>
                                <th>Bill of Lading</th>
                                <th>Date/Time</th>
                                <th>Remarque</th>
                                <th class="admin-only">Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            </tbody>
                    </table>
                </div>

                <div id="invoicing-view" class="view">
                    <h2>Invoicing</h2>
                    <form id="invoiceForm" class="form">
                        <div class="form-group">
                            <label for="invoiceNo">Invoice No:</label>
                            <input type="text" id="invoiceNo" required readonly style="background-color: var(--input-bg); color: var(--text-dark);">
                        </div>
                        <div class="form-group">
                            <label for="invoiceCreatedDate">Created Documents Date:</label>
                            <input type="date" id="invoiceCreatedDate" required>
                        </div>
                        <div class="form-group">
                            <label for="invoiceLcNumber">LC Number:</label>
                            <input type="text" id="invoiceLcNumber">
                        </div>
                        <div class="form-group">
                            <label for="invoiceTinNumber">TIN Number:</label>
                            <input type="text" id="invoiceTinNumber">
                        </div>
                        <div class="form-group">
                            <label for="invoiceProformaNumber">Proforma Number:</label>
                            <input type="text" id="invoiceProformaNumber">
                        </div>
                        <div class="form-group">
                            <label for="invoiceProformaDate">Date of Proforma:</label>
                            <input type="date" id="invoiceProformaDate">
                        </div>
                        <div class="form-group">
                            <label for="invoiceNotify">Notify:</label>
                            <input type="text" id="invoiceNotify">
                        </div>
                        <div class="form-group">
                            <label for="invoiceConsignee">Consignee:</label>
                            <input type="text" id="invoiceConsignee">
                        </div>
                         <div class="form-group">
                            <label for="invoicePortLoading">Port of Loading/Airport of Dep:</label>
                            <input type="text" id="invoicePortLoading" value="DJIBOUTI FREE ZONE">
                        </div>
                        <div class="form-group">
                            <label for="invoicePortDischarge">Port of Discharge/Airport of Dest:</label>
                            <input type="text" id="invoicePortDischarge" value="ADDIS ABABA, ETHIOPIA">
                        </div>
                        <div class="form-group">
                            <label for="invoiceShipment">Shipment Type:</label>
                            <input type="text" id="invoiceShipment" value="SELF DRIVE">
                        </div>
                        <div class="form-group">
                            <label for="invoiceTermsPayment">Terms of Payment:</label>
                            <input type="text" id="invoiceTermsPayment" value="LC">
                        </div>
                         <div class="form-group">
                            <label for="invoiceBank">Bank:</label>
                            <input type="text" id="invoiceBank" value="CAC INTERNATIONAL BANK">
                        </div>
                        <div class="form-group">
                            <label for="invoiceAccountNo">Account Number:</label>
                            <input type="text" id="invoiceAccountNo" value="1003471115">
                        </div>
                        <div class="form-group">
                            <label for="invoiceSwift">SWIFT:</label>
                            <input type="text" id="invoiceSwift" value="CACDDJJD">
                        </div>

                        <h3>Items (Chassis Numbers)</h3>
                        <div id="invoice-items-container">
                            <!-- Invoice item rows will be added here dynamically -->
                        </div>
                        <button type="button" id="addInvoiceItem">Add Item</button>
                        <div class="form-group" style="margin-top: 20px;">
                            <label for="invoiceGrandTotal">Grand Total (USD):</label>
                            <input type="text" id="invoiceGrandTotal" readonly style="background-color: var(--input-bg); font-weight: bold; color: var(--accent-blue);">
                        </div>
                        <div style="margin-top: 20px; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 10px;">
                            <button type="submit" id="submitInvoiceBtn">Create Invoice</button>
                            <button type="button" id="cancelInvoiceEditBtn" style="display: none;">Cancel Edit</button>
                            <button type="button" id="generateInvoicePrint" class="generate-doc-btn" style="display: none;">Generate Printable Invoice</button>
                            <button type="button" id="exportInvoiceToExcel" class="generate-doc-btn">Export to Excel</button>
                            <label for="importInvoiceExcel" class="custom-file-upload">
                                Import from Excel
                            </label>
                            <input type="file" id="importInvoiceExcel" accept=".xlsx, .xls">
                        </div>
                    </form>

                    <div id="invoices-list-container">
                        <h3>Existing Invoices</h3>
                        <table id="invoicesTable" class="data-table">
                            <thead>
                                <tr>
                                    <th>Invoice No</th>
                                    <th>Consignee</th>
                                    <th>Total Amount</th>
                                    <th>Date</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                            </tbody>
                        </table>
                    </div>
                </div>

                <div id="packing-list-view" class="view">
                    <h2>Packing List</h2>
                    <form id="packingListForm" class="form">
                        <div class="form-group">
                            <label for="packingListNo">Packing List No:</label>
                            <input type="text" id="packingListNo" required readonly style="background-color: var(--input-bg); color: var(--text-dark);">
                        </div>
                        <div class="form-group">
                            <label for="packingListCreatedDate">Created Documents Date:</label>
                            <input type="date" id="packingListCreatedDate" required>
                        </div>
                        <div class="form-group">
                            <label for="packingListInvoiceNo">Associated Invoice No:</label>
                            <input type="text" id="packingListInvoiceNo">
                        </div>
                        <div class="form-group">
                            <label for="packingListLcNumber">LC Number:</label>
                            <input type="text" id="packingListLcNumber">
                        </div>
                        <div class="form-group">
                            <label for="packingListTinNumber">TIN Number:</label>
                            <input type="text" id="packingListTinNumber">
                        </div>
                        <div class="form-group">
                            <label for="packingListProformaNumber">Proforma Number:</label>
                            <input type="text" id="packingListProformaNumber">
                        </div>
                        <div class="form-group">
                            <label for="packingListProformaDate">Date of Proforma:</label>
                            <input type="date" id="packingListProformaDate">
                        </div>
                        <div class="form-group">
                            <label for="packingListNotify">Notify Party:</label>
                            <input type="text" id="packingListNotify">
                        </div>
                        <div class="form-group">
                            <label for="packingListConsignee">Consignee:</label>
                            <input type="text" id="packingListConsignee">
                        </div>
                        <div class="form-group">
                            <label for="packingListMarksNumbers">Marks & Numbers:</label>
                            <input type="text" id="packingListMarksNumbers">
                        </div>
                        <div class="form-group">
                            <label for="packingListGoodsCountryOrigin">Goods Country of Origin:</label>
                            <input type="text" id="packingListGoodsCountryOrigin" value="CHINA">
                        </div>

                        <h3>Items (Chassis Numbers)</h3>
                        <div id="packing-list-items-container">
                            <!-- Packing list item rows will be added here dynamically -->
                        </div>
                        <button type="button" id="addPackingListItem">Add Item</button>
                        <div style="margin-top: 20px; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 10px;">
                            <button type="submit" id="submitPackingListBtn">Create Packing List</button>
                            <button type="button" id="cancelPackingListEditBtn" style="display: none;">Cancel Edit</button>
                            <button type="button" id="generatePackingListPrint" class="generate-doc-btn" style="display: none;">Generate Printable Packing List</button>
                            <button type="button" id="exportPackingListToExcel" class="generate-doc-btn">Export to Excel</button>
                            <label for="importPackingListExcel" class="custom-file-upload">
                                Import from Excel
                            </label>
                            <input type="file" id="importPackingListExcel" accept=".xlsx, .xls">
                        </div>
                    </form>

                    <div id="packing-lists-list-container">
                        <h3>Existing Packing Lists</h3>
                        <table id="packingListsTable" class="data-table">
                            <thead>
                                <tr>
                                    <th>PL No</th>
                                    <th>Invoice No</th>
                                    <th>Consignee</th>
                                    <th>Date</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                            </tbody>
                        </table>
                    </div>
                </div>

                <div id="truck-waybill-view" class="view">
                    <h2>Truck Waybill</h2>
                    <form id="truckWaybillForm" class="form">
                        <div class="form-group">
                            <label for="waybillNo">Waybill No:</label>
                            <input type="text" id="waybillNo" required readonly style="background-color: var(--input-bg); color: var(--text-dark);">
                        </div>
                        <div class="form-group">
                            <label for="waybillCreatedDate">Created Documents Date:</label>
                            <input type="date" id="waybillCreatedDate" required>
                        </div>
                        <div class="form-group">
                            <label for="waybillInvoiceNo">Associated Invoice No:</label>
                            <input type="text" id="waybillInvoiceNo">
                        </div>
                        <div class="form-group">
                            <label for="waybillLcNumber">LC Number:</label>
                            <input type="text" id="waybillLcNumber">
                        </div>
                        <div class="form-group">
                            <label for="waybillTinNumber">TIN Number:</label>
                            <input type="text" id="waybillTinNumber">
                        </div>
                        <div class="form-group">
                            <label for="waybillProformaNumber">Proforma Number:</label>
                            <input type="text" id="waybillProformaNumber">
                        </div>
                        <div class="form-group">
                            <label for="waybillProformaDate">Date of Proforma:</label>
                            <input type="date" id="waybillProformaDate">
                        </div>
                        <div class="form-group">
                            <label for="waybillNotify">Notify:</label>
                            <input type="text" id="waybillNotify">
                        </div>
                        <div class="form-group">
                            <label for="waybillConsignee">Consignee:</label>
                            <input type="text" id="waybillConsignee">
                        </div>
                         <div class="form-group">
                            <label for="waybillShipper">Shipper (Sender):</label>
                            <input type="text" id="waybillShipper" value="HOJAFA AUTO LTD FZE">
                        </div>
                        <div class="form-group">
                            <label for="waybillPortLoading">Port of Loading/Departure:</label>
                            <input type="text" id="waybillPortLoading" value="DJIBOUTI FREE ZONE">
                        </div>
                        <div class="form-group">
                            <label for="waybillPortDischarge">Port of Discharge/Destination:</label>
                            <input type="text" id="waybillPortDischarge" value="ADDIS ABABA, ETHIOPIA">
                        </div>
                         <div class="form-group">
                            <label for="waybillLatestShipmentDate">Latest Date of Shipment:</label>
                            <input type="date" id="waybillLatestShipmentDate">
                        </div>
                         <div class="form-group">
                            <label for="waybillGoodsCountryOrigin">Goods Country of Origin:</label>
                            <input type="text" id="waybillGoodsCountryOrigin" value="CHINA">
                        </div>
                        <div class="form-group">
                            <label for="waybillThirdPartyAgent">THIRD PARTY or ITS agent:</label>
                            <input type="text" id="waybillThirdPartyAgent">
                        </div>


                        <h3>Items for Shipment</h3>
                        <div id="waybill-items-container">
                            <!-- Waybill item rows will be added here dynamically -->
                        </div>
                        <button type="button" id="addWaybillItem">Add Item</button>

                        <div class="form-group" style="margin-top: 20px;">
                            <label for="waybillOverallGrossWeight">Overall Gross Weight (KGS):</label>
                            <input type="number" id="waybillOverallGrossWeight" step="0.01" readonly style="background-color: var(--input-bg); font-weight: bold; color: var(--accent-blue);">
                        </div>
                        <div class="form-group">
                            <label for="waybillOverallMeasurement">Overall Measurement (CBM):</label>
                            <input type="number" id="waybillOverallMeasurement" step="0.01" readonly style="background-color: var(--input-bg); font-weight: bold; color: var(--accent-blue);">
                        </div>
                        <div class="form-group">
                            <label for="waybillFreightPayable">Freight Payable At:</label>
                            <input type="text" id="waybillFreightPayable" value="DESTINATION" readonly style="background-color: var(--input-bg); color: var(--text-dark);">
                        </div>

                        <div style="margin-top: 20px; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 10px;">
                            <button type="submit" id="submitWaybillBtn">Create Waybill</button>
                            <button type="button" id="cancelWaybillEditBtn" style="display: none;">Cancel Edit</button>
                            <button type="button" id="generateWaybillPrint" class="generate-doc-btn" style="display: none;">Generate Printable Waybill</button>
                            <button type="button" id="exportWaybillToExcel" class="generate-doc-btn">Export to Excel</button>
                            <label for="importWaybillExcel" class="custom-file-upload">
                                Import from Excel
                            </label>
                            <input type="file" id="importWaybillExcel" accept=".xlsx, .xls">
                        </div>
                    </form>

                    <div id="waybills-list-container">
                        <h3>Existing Truck Waybills</h3>
                        <table id="waybillsTable" class="data-table">
                            <thead>
                                <tr>
                                    <th>Waybill No</th>
                                    <th>Invoice No</th>
                                    <th>Consignee</th>
                                    <th>Date</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                            </tbody>
                        </table>
                    </div>
                </div>

                <div id="document-archive-view" class="view">
                    <h2>Document Archive</h2>
                    <form id="archiveDocumentForm" class="form">
                        <div class="form-group">
                            <label for="archiveDocName">Document Name:</label>
                            <input type="text" id="archiveDocName" required placeholder="e.g., Chassis Inspection Report">
                        </div>
                        <div class="form-group">
                            <label for="archiveDocCategory">Category:</label>
                            <input type="text" id="archiveDocCategory" placeholder="e.g., Legal, Financial, Technical">
                        </div>
                        <div class="form-group">
                            <label for="archiveDocAssociatedRef">Associated Chassis/Invoice No.:</label>
                            <input type="text" id="archiveDocAssociatedRef" placeholder="e.g., CH00123, HJF-INV-0001">
                        </div>
                        <div class="form-group">
                            <label for="archiveDocFile" class="custom-file-upload">
                                Upload Document
                            </label>
                            <input type="file" id="archiveDocFile" accept=".pdf, .doc, .docx, .xls, .xlsx, .jpg, .jpeg, .png">
                            <span id="archiveFileName" style="margin-left: 10px; color: var(--text-dark);">No file chosen</span>
                        </div>
                        <button type="submit">Archive Document</button>
                    </form>

                    <div id="archived-documents-list-container">
                        <h3>Archived Documents</h3>
                        <table id="archivedDocumentsTable" class="data-table">
                            <thead>
                                <tr>
                                    <th>Document Name</th>
                                    <th>Category</th>
                                    <th>Associated Ref</th>
                                    <th>File Name</th>
                                    <th>Upload Date</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                            </tbody>
                        </table>
                    </div>
                </div>

                <div id="manage-users-view" class="view">
                    <h2>Manage Users</h2>
                    <div id="user-list-container">
                        <h3>Existing Users</h3>
                        <ul id="user-list">
                            </ul>
                    </div>

                    <div id="add-user-container" style="margin-top: 20px; border-top: 1px solid var(--border-color); padding-top: 15px; text-align: left;">
                        <h3>Add New User</h3>
                        <form id="add-user-form">
                            <div class="form-group">
                                <label for="new-username">Username:</label>
                                <input type="text" id="new-username" required>
                            </div>
                            <div class="form-group">
                                <label for="add-password">Password:</label>
                                <input type="password" id="add-password" required>
                            </div>
                             <div class="form-group">
                                <label for="add-confirm-password">Confirm Password:</label>
                                <input type="password" id="add-confirm-password" required>
                            </div>
                            <div class="form-group">
                                <label for="new-user-role">Role:</label>
                                <select id="new-user-role">
                                    <option value="user">User</option>
                                    <option value="admin">Admin</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Document Permissions:</label>
                                <div class="checkbox-group">
                                    <input type="checkbox" id="add-can-access-invoices" checked>
                                    <label for="add-can-access-invoices">Can Access Invoices</label>
                                </div>
                                <div class="checkbox-group">
                                    <input type="checkbox" id="add-can-edit-invoices" checked>
                                    <label for="add-can-edit-invoices">Can Edit Commercial Invoice</label>
                                </div>
                                <div class="checkbox-group">
                                    <input type="checkbox" id="add-can-access-packing-lists" checked>
                                    <label for="add-can-access-packing-lists">Can Access Packing Lists</label>
                                </div>
                                <div class="checkbox-group">
                                    <input type="checkbox" id="add-can-edit-packing-lists" checked>
                                    <label for="add-can-edit-packing-lists">Can Edit Packing List</label>
                                </div>
                                <div class="checkbox-group">
                                    <input type="checkbox" id="add-can-access-truck-waybills" checked>
                                    <label for="add-can-access-truck-waybills">Can Access Truck Waybills</label>
                                </div>
                                <div class="checkbox-group">
                                    <input type="checkbox" id="add-can-edit-truck-waybills" checked>
                                    <label for="add-can-edit-truck-waybills">Can Edit Truck Waybill</label>
                                </div>
                            </div>
                            <button type="submit">Add User</button>
                        </form>
                    </div>

                    <div id="edit-user-container" style="margin-top: 20px; border-top: 1px solid var(--border-color); padding-top: 15px; text-align: left; display: none;">
                        <h3>Edit User: <span id="editing-username"></span></h3>
                        <form id="edit-user-form">
                            <div class="form-group">
                                <label for="edit-new-password">New Password:</label>
                                <input type="password" id="edit-new-password">
                                <small style="color: var(--text-muted);">Leave blank to keep current password.</small>
                            </div>
                             <div class="form-group">
                                <label for="edit-confirm-password">Confirm New Password:</label>
                                <input type="password" id="edit-confirm-password">
                            </div>
                            <div class="form-group">
                                <label for="edit-user-role">Role:</label>
                                <select id="edit-user-role">
                                    <option value="user">User</option>
                                    <option value="admin">Admin</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Document Permissions:</label>
                                <div class="checkbox-group">
                                    <input type="checkbox" id="edit-can-access-invoices">
                                    <label for="edit-can-access-invoices">Can Access Invoices</label>
                                </div>
                                <div class="checkbox-group">
                                    <input type="checkbox" id="edit-can-edit-invoices">
                                    <label for="edit-can-edit-invoices">Can Edit Commercial Invoice</label>
                                </div>
                                <div class="checkbox-group">
                                    <input type="checkbox" id="edit-can-access-packing-lists">
                                    <label for="edit-can-access-packing-lists">Can Access Packing Lists</label>
                                </div>
                                <div class="checkbox-group">
                                    <input type="checkbox" id="edit-can-edit-packing-lists">
                                    <label for="edit-can-edit-packing-lists">Can Edit Packing List</label>
                                </div>
                                <div class="checkbox-group">
                                    <input type="checkbox" id="edit-can-access-truck-waybills">
                                    <label for="edit-can-access-truck-waybills">Can Access Truck Waybills</label>
                                </div>
                                <div class="checkbox-group">
                                    <input type="checkbox" id="edit-can-edit-truck-waybills">
                                    <label for="edit-can-edit-truck-waybills">Can Edit Truck Waybill</label>
                                </div>
                            </div>
                            <button type="submit">Update User</button>
                            <button type="button" id="cancel-edit">Cancel</button>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Get references to DOM elements
        const loginContainer = document.getElementById('login-container');
        const appWrapper = document.getElementById('app-wrapper'); // Changed from mainContainer
        const loginForm = document.getElementById('loginForm');
        const usernameInput = document.getElementById('username');
        const passwordInput = document.getElementById('password');
        const navLogoutButton = document.getElementById('nav-logout');
        const navManageUsersButton = document.getElementById('nav-manage-users');
        const manageUsersView = document.getElementById('manage-users-view');
        const userListElement = document.getElementById('user-list');

        // Elements for adding new user
        const addUserForm = document.getElementById('add-user-form');
        const newUsernameInput = document.getElementById('new-username');
        const addPasswordInput = document.getElementById('add-password');
        const addConfirmPasswordInput = document.getElementById('add-confirm-password');
        const newUserRoleSelect = document.getElementById('new-user-role'); // NEW
        const addCanAccessInvoices = document.getElementById('add-can-access-invoices'); // NEW PERMISSION
        const addCanEditInvoices = document.getElementById('add-can-edit-invoices'); // NEW PERMISSION
        const addCanAccessPackingLists = document.getElementById('add-can-access-packing-lists'); // NEW PERMISSION
        const addCanEditPackingLists = document.getElementById('add-can-edit-packing-lists'); // NEW PERMISSION
        const addCanAccessTruckWaybills = document.getElementById('add-can-access-truck-waybills'); // NEW PERMISSION
        const addCanEditTruckWaybills = document.getElementById('add-can-edit-truck-waybills'); // NEW PERMISSION

        // Elements for editing existing user
        const editUserContainer = document.getElementById('edit-user-container');
        const editingUsernameSpan = document.getElementById('editing-username');
        const editUserForm = document.getElementById('edit-user-form');
        const editNewPasswordInput = document.getElementById('edit-new-password');
        const editConfirmPasswordInput = document.getElementById('edit-confirm-password');
        const editUserRoleSelect = document.getElementById('edit-user-role'); // NEW
        const editCanAccessInvoices = document.getElementById('edit-can-access-invoices'); // NEW PERMISSION
        const editCanEditInvoices = document.getElementById('edit-can-edit-invoices'); // NEW PERMISSION
        const editCanAccessPackingLists = document.getElementById('edit-can-access-packing-lists'); // NEW PERMISSION
        const editCanEditPackingLists = document.getElementById('edit-can-edit-packing-lists'); // NEW PERMISSION
        const editCanAccessTruckWaybills = document.getElementById('edit-can-access-truck-waybills'); // NEW PERMISSION
        const editCanEditTruckWaybills = document.getElementById('edit-can-edit-truck-waybills'); // NEW PERMISSION
        const cancelEditButton = document.getElementById('cancel-edit');

        const loggedInUserElement = document.getElementById('logged-in-user');
        const historyActionsHeader = document.querySelector('#historyTable th.admin-only');


        const checkinForm = document.getElementById('checkinForm');
        const checkoutForm = document.getElementById('checkoutForm');

        const historyTableBody = document.querySelector('#historyTable tbody');
        const messageBox = document.getElementById('message-box');
        const exportHistoryButton = document.getElementById('exportHistory');
        const importExcelInput = document.getElementById('importExcel');
        const customFileUploadLabel = document.querySelector('.custom-file-upload');
        const chassisSearchInput = document.getElementById('chassisSearchInput');
        const searchChassisButton = document.getElementById('searchChassisButton');
        const printHistoryButton = document.getElementById('printHistory');


        // Remarque input fields
        const checkinRemarqueInput = document.getElementById('checkinRemarque');
        const checkoutRemarqueInput = document.getElementById('checkoutRemarque');


        // Elements for displaying counts
        const totalCheckedInElement = document.getElementById('totalCheckedIn');
        const totalCheckedOutElement = document.getElementById('totalCheckedOut');

        // Input element for Bill of Lading
        const checkinBillOfLadingInput = document.getElementById('checkinBillOfLading');

        // Element for Bill of Lading breakdown list
        const billOfLadingListElement = document.getElementById('billOfLadingList');


        // Navigation buttons
        const navDashboard = document.getElementById('nav-dashboard');
        const navCheckin = document.getElementById('nav-checkin');
        const navCheckout = document.getElementById('nav-checkout');
        const navInventory = document.getElementById('nav-inventory');
        const navHistory = document.getElementById('nav-history');
        const navInvoicing = document.getElementById('nav-invoicing');
        const navPackingList = document.getElementById('nav-packing-list');
        const navTruckWaybill = document.getElementById('nav-truck-waybill');
        const navDocumentArchive = document.getElementById('nav-document-archive'); /* NEW */


        // View divs
        const dashboardView = document.getElementById('dashboard-view');
        const checkinView = document.getElementById('checkin-view');
        const checkoutView = document.getElementById('checkout-view');
        const inventoryView = document.getElementById('inventory-view');
        const historyView = document.getElementById('history-view');
        const invoicingView = document.getElementById('invoicing-view');
        const packingListView = document.getElementById('packing-list-view');
        const truckWaybillView = document.getElementById('truck-waybill-view');
        const documentArchiveView = document.getElementById('document-archive-view'); /* NEW */


        // Invoicing elements
        const invoiceForm = document.getElementById('invoiceForm');
        const invoiceNoInput = document.getElementById('invoiceNo');
        const invoiceCreatedDateInput = document.getElementById('invoiceCreatedDate'); // NEW
        const invoiceLcNumberInput = document.getElementById('invoiceLcNumber');
        const invoiceTinNumberInput = document.getElementById('invoiceTinNumber');
        const invoiceProformaNumberInput = document.getElementById('invoiceProformaNumber');
        const invoiceProformaDateInput = document.getElementById('invoiceProformaDate');
        const invoiceNotify = document.getElementById('invoiceNotify');
        const invoiceConsignee = document.getElementById('invoiceConsignee');
        const invoicePortLoadingInput = document.getElementById('invoicePortLoading');
        const invoicePortDischargeInput = document.getElementById('invoicePortDischarge');
        const invoiceShipment = document.getElementById('invoiceShipment');
        const invoiceTermsPayment = document.getElementById('invoiceTermsPayment');
        const invoiceBank = document.getElementById('invoiceBank');
        const invoiceAccountNo = document.getElementById('invoiceAccountNo');
        const invoiceSwift = document.getElementById('invoiceSwift');
        const invoiceItemsContainer = document.getElementById('invoice-items-container');
        const addInvoiceItemButton = document.getElementById('addInvoiceItem');
        const submitInvoiceBtn = document.getElementById('submitInvoiceBtn');
        const cancelInvoiceEditBtn = document.getElementById('cancelInvoiceEditBtn');
        const generateInvoicePrintButton = document.getElementById('generateInvoicePrint');
        const invoicesTableBody = document.querySelector('#invoicesTable tbody');
        const invoiceGrandTotalInput = document.getElementById('invoiceGrandTotal');
        let currentEditingInvoice = null;

        // Packing List elements
        const packingListForm = document.getElementById('packingListForm');
        const packingListNoInput = document.getElementById('packingListNo');
        const packingListCreatedDateInput = document.getElementById('packingListCreatedDate'); // NEW
        const packingListInvoiceNoInput = document.getElementById('packingListInvoiceNo');
        const packingListLcNumberInput = document.getElementById('packingListLcNumber');
        const packingListTinNumberInput = document.getElementById('packingListTinNumber');
        const packingListProformaNumberInput = document.getElementById('packingListProformaNumber');
        const packingListProformaDateInput = document.getElementById('packingListProformaDate');
        const packingListNotifyInput = document.getElementById('packingListNotify');
        const packingListConsignee = document.getElementById('packingListConsignee');
        const packingListMarksNumbers = document.getElementById('packingListMarksNumbers');
        const packingListGoodsCountryOriginInput = document.getElementById('packingListGoodsCountryOrigin');

        const packingListItemsContainer = document.getElementById('packing-list-items-container');
        const addPackingListItemButton = document.getElementById('addPackingListItem');
        const submitPackingListBtn = document.getElementById('submitPackingListBtn');
        const cancelPackingListEditBtn = document.getElementById('cancelPackingListEditBtn');
        const generatePackingListPrintButton = document.getElementById('generatePackingListPrint');
        const packingListsTableBody = document.querySelector('#packingListsTable tbody');
        let currentEditingPackingList = null;

        // Truck Waybill elements
        const truckWaybillForm = document.getElementById('truckWaybillForm');
        const waybillNoInput = document.getElementById('waybillNo');
        const waybillCreatedDateInput = document.getElementById('waybillCreatedDate'); // NEW
        const waybillInvoiceNoInput = document.getElementById('waybillInvoiceNo');
        const waybillLcNumberInput = document.getElementById('waybillLcNumber');
        const waybillTinNumberInput = document.getElementById('waybillTinNumber');
        const waybillProformaNumberInput = document.getElementById('waybillProformaNumber');
        const waybillProformaDateInput = document.getElementById('waybillProformaDate');
        const waybillNotifyInput = document.getElementById('waybillNotify');
        const waybillItemsContainer = document.getElementById('waybill-items-container');
        const addWaybillItemButton = document.getElementById('addWaybillItem');
        const submitWaybillBtn = document.getElementById('submitWaybillBtn');
        const cancelWaybillEditBtn = document.getElementById('cancelWaybillEditBtn');
        const generateWaybillPrintButton = document.getElementById('generateWaybillPrint');
        const waybillsTableBody = document.querySelector('#waybillsTable tbody');
        const waybillLatestShipmentDateInput = document.getElementById('waybillLatestShipmentDate');
        const waybillOverallGrossWeightInput = document.getElementById('waybillOverallGrossWeight');
        const waybillOverallMeasurementInput = document.getElementById('waybillOverallMeasurement');
        const waybillFreightPayableInput = document.getElementById('waybillFreightPayable');
        const waybillGoodsCountryOriginInput = document.getElementById('waybillGoodsCountryOrigin');
        const waybillThirdPartyAgentInput = document.getElementById('waybillThirdPartyAgent');
        let currentEditingWaybill = null;

        // Document Archive elements /* NEW */
        const archiveDocumentForm = document.getElementById('archiveDocumentForm');
        const archiveDocNameInput = document.getElementById('archiveDocName');
        const archiveDocCategoryInput = document.getElementById('archiveDocCategory');
        const archiveDocAssociatedRefInput = document.getElementById('archiveDocAssociatedRef');
        const archiveDocFileInput = document.getElementById('archiveDocFile');
        const archiveFileNameSpan = document.getElementById('archiveFileName');
        const archivedDocumentsTableBody = document.querySelector('#archivedDocumentsTable tbody');


        // Dashboard elements
        const dashboardCheckedIn = document.getElementById('dashboard-checked-in');
        const dashboardCheckedOut = document.getElementById('dashboard-checked-out');
        const dashboardAvailableChassis = document.getElementById('dashboard-available-chassis');
        const dashboardInvoices = document.getElementById('dashboard-invoices');
        const dashboardPackingLists = document.getElementById('dashboard-packing-lists');
        const dashboardWaybills = document.getElementById('dashboard-waybills');
        const dashboardArchivedDocuments = document.getElementById('dashboard-archived-documents'); /* NEW */
        const dashboardRecentActivity = document.getElementById('dashboard-recent-activity');

        // Chart elements
        let chassisStatusChartInstance = null;
        let documentTypeChartInstance = null;

        // History Yard Summary elements (NEW)
        const historyInYardCount = document.getElementById('history-in-yard-count');
        const viewInventoryLink = document.getElementById('view-inventory-link');


        // Data storage arrays
        let transactions = loadTransactions();
        let invoices = loadInvoices();
        let packingLists = loadPackingLists();
        let waybills = loadWaybills();
        let archivedDocuments = loadArchivedDocuments(); /* NEW */


        // Variable to store the current search term for history
        let currentSearchTerm = '';

        // --- NEW CANVAS VISUALIZATION ELEMENTS AND CONFIG ---
        const chassisYardCanvas = document.getElementById('chassisYardCanvas');
        const ctxChassisYard = chassisYardCanvas ? chassisYardCanvas.getContext('2d') : null;
        const detailsBox = document.getElementById('chassis-details-box');
        const closeDetailsBtn = document.getElementById('close-details-btn');

        // Configuration for the Yard Visualization
        const YARD_ROWS = 10; // Number of rows in the yard
        const YARD_COLS = 15; // Number of columns in the yard
        const SPOT_PADDING = 5; // Padding around each spot
        const CHASSIS_RADIUS_RATIO = 0.4; // Radius of chassis circle relative to spot size
        // --- END NEW CANVAS VISUALIZATION ELEMENTS AND CONFIG ---


        // --- Authentication and User Management Logic ---

        // Key for storing users in local storage
        const USERS_STORAGE_KEY = 'chassisAppUsers';

        // Variable to store the currently logged-in username and role
        let loggedInUsername = null;
        let currentUserPermissions = {
            role: null,
            canAccessInvoices: false,
            canEditInvoices: false, // NEW
            canAccessPackingLists: false,
            canEditPackingLists: false, // NEW
            canAccessTruckWaybills: false,
            canEditTruckWaybills: false // NEW
        };

        // Function to save users to local storage
        function saveUsers(usersData) {
            try {
                localStorage.setItem(USERS_STORAGE_KEY, JSON.stringify(usersData));
            } catch (e) {
                console.error('Error saving users to local storage:', e);
                showMessage('Could not save user data locally.', 'error');
            }
        }

        // Function to load users from local storage
        function loadUsers() {
            try {
                const storedUsers = localStorage.getItem(USERS_STORAGE_KEY);
                if (storedUsers) {
                    const usersData = JSON.parse(storedUsers);
                    // Ensure default permissions for existing users if not present
                    for (const username in usersData) {
                        if (typeof usersData[username] === 'string') { // Old format: just password string
                            usersData[username] = {
                                password: usersData[username],
                                role: (username === 'Medfarah') ? 'admin' : 'user',
                                canAccessInvoices: true, // Default to true for existing users
                                canEditInvoices: true, // Default to true for existing users
                                canAccessPackingLists: true,
                                canEditPackingLists: true, // Default to true for existing users
                                canAccessTruckWaybills: true,
                                canEditTruckWaybills: true // Default to true for existing users
                            };
                        } else {
                            // Ensure all permission flags exist and default to true if missing
                            usersData[username].role = usersData[username].role || 'user';
                            usersData[username].canAccessInvoices = usersData[username].canAccessInvoices !== undefined ? usersData[username].canAccessInvoices : true;
                            usersData[username].canEditInvoices = usersData[username].canEditInvoices !== undefined ? usersData[username].canEditInvoices : true; // NEW
                            usersData[username].canAccessPackingLists = usersData[username].canAccessPackingLists !== undefined ? usersData[username].canAccessPackingLists : true;
                            usersData[username].canEditPackingLists = usersData[username].canEditPackingLists !== undefined ? usersData[username].canEditPackingLists : true; // NEW
                            usersData[username].canAccessTruckWaybills = usersData[username].canAccessTruckWaybills !== undefined ? usersData[username].canAccessTruckWaybills : true;
                            usersData[username].canEditTruckWaybills = usersData[username].canEditTruckWaybills !== undefined ? usersData[username].canEditTruckWaybills : true; // NEW
                        }
                    }
                    // Ensure default users exist if not present in storage
                    if (!usersData['Medfarah']) {
                        usersData['Medfarah'] = { password: 'admin123', role: 'admin', canAccessInvoices: true, canEditInvoices: true, canAccessPackingLists: true, canEditPackingLists: true, canAccessTruckWaybills: true, canEditTruckWaybills: true };
                    }
                    if (!usersData['Fasil']) {
                        usersData['Fasil'] = { password: 'user123', role: 'user', canAccessInvoices: true, canEditInvoices: false, canAccessPackingLists: true, canEditPackingLists: false, canAccessTruckWaybills: true, canEditTruckWaybills: false };
                    }
                    return usersData;
                }
            } catch (e) {
                console.error('Error loading users from local storage:', e);
                showMessage('Could not load user data from local storage.', 'error');
            }
            // Return default users if no data or error
            return {
                'Medfarah': { password: 'admin123', role: 'admin', canAccessInvoices: true, canEditInvoices: true, canAccessPackingLists: true, canEditPackingLists: true, canAccessTruckWaybills: true, canEditTruckWaybills: true },
                'Fasil': { password: 'user123', role: 'user', canAccessInvoices: true, canEditInvoices: false, canAccessPackingLists: true, canEditPackingLists: false, canAccessTruckWaybills: true, canEditTruckWaybills: false }
            };
        }

        // Load users on application start
        let users = loadUsers();

        // Function to handle login
        function handleLogin(event) {
            event.preventDefault();

            const username = usernameInput.value.trim();
            const password = passwordInput.value.trim();

            if (users[username] && users[username].password === password) { // Check password from user object
                loggedInUsername = username;
                currentUserPermissions = { ...users[username] }; // Copy all user properties (including permissions)

                displayLoggedInUser();
                loginContainer.style.display = 'none';
                appWrapper.style.display = 'flex'; // Show appWrapper
                updateUIBasedOnRole();
                showView('dashboard-view');
                drawHistory();
                drawInventory();
                drawInvoices();
                drawPackingLists();
                drawWaybills();
                drawArchivedDocuments(); /* NEW */
                updateDashboard();
                updateCharts();

            } else {
                showMessage('Invalid username or password.', 'error');
            }

            passwordInput.value = '';
        }

        // Function to handle logout
        function handleLogout() {
            showConfirmation('Are you sure you want to log out?', () => {
                loggedInUsername = null;
                currentUserPermissions = {
                    role: null,
                    canAccessInvoices: false,
                    canEditInvoices: false, // NEW
                    canAccessPackingLists: false,
                    canEditPackingLists: false, // NEW
                    canAccessTruckWaybills: false,
                    canEditTruckWaybills: false // NEW
                };
                displayLoggedInUser();
                appWrapper.style.display = 'none'; // Hide appWrapper
                loginContainer.style.display = 'flex'; // Show loginContainer
                updateUIBasedOnRole();
                showMessage('Logged out successfully.');
                usernameInput.value = '';
                passwordInput.value = '';
            });
        }

        // Function to display the currently logged-in user
        function displayLoggedInUser() {
            if (loggedInUsername) {
                loggedInUserElement.textContent = `Logged in as: ${loggedInUsername} (${currentUserPermissions.role})`;
            } else {
                loggedInUserElement.textContent = '';
            }
        }

        // Function to update UI elements based on the user's role and permissions
        function updateUIBasedOnRole() {
            const navManageUsersButton = document.getElementById('nav-manage-users');
            const customFileUploadLabel = document.querySelector('.custom-file-upload');
            const exportHistoryButton = document.getElementById('exportHistory');
            const historyActionsHeader = document.querySelector('#historyTable th.admin-only');
            const searchContainer = document.querySelector('.search-container');
            const printHistoryButton = document.getElementById('printHistory');
            const addUserContainer = document.getElementById('add-user-container');

            // Admin specific UI elements
            if (currentUserPermissions.role === 'admin') {
                if (navManageUsersButton) navManageUsersButton.style.display = 'flex';
                if (customFileUploadLabel) customFileUploadLabel.style.display = 'inline-block';
                if (exportHistoryButton) exportHistoryButton.style.display = 'inline-block';
                if (historyActionsHeader) historyActionsHeader.style.display = 'table-cell';
                if (addUserContainer) addUserContainer.style.display = 'block';
            } else {
                if (navManageUsersButton) navManageUsersButton.style.display = 'none';
                if (customFileUploadLabel) customFileUploadLabel.style.display = 'none';
                if (exportHistoryButton) exportHistoryButton.style.display = 'inline-block'; // Users can export history
                if (historyActionsHeader) historyActionsHeader.style.display = 'none';
                if (addUserContainer) addUserContainer.style.display = 'none';
            }

            // Document specific navigation buttons based on permissions
            if (navInvoicing) navInvoicing.style.display = currentUserPermissions.canAccessInvoices ? 'flex' : 'none';
            if (navPackingList) navPackingList.style.display = currentUserPermissions.canAccessPackingLists ? 'flex' : 'none';
            if (navTruckWaybill) navTruckWaybill.style.display = currentUserPermissions.canAccessTruckWaybills ? 'flex' : 'none';
            if (navDocumentArchive) navDocumentArchive.style.display = 'flex'; // Document Archive always visible

            // General UI elements
            if (searchContainer) searchContainer.style.display = 'flex';
            if (printHistoryButton) printHistoryButton.style.display = 'inline-block';
        }


        // Function to draw the list of users in the Manage Users view
        function drawUsers() {
            if (!userListElement) {
                console.error("User list element not found.");
                return;
            }
            userListElement.innerHTML = '';
            const usernames = Object.keys(users);

            if (usernames.length === 0) {
                const listItem = document.createElement('li');
                listItem.textContent = 'No users found.';
                userListElement.appendChild(listItem);
                return;
            }

            usernames.forEach(username => {
                const listItem = document.createElement('li');
                const user = users[username];
                let permissionsText = [];
                if (user.canAccessInvoices) permissionsText.push('Access Invoices');
                if (user.canEditInvoices) permissionsText.push('Edit Invoices'); // NEW
                if (user.canAccessPackingLists) permissionsText.push('Access Packing Lists');
                if (user.canEditPackingLists) permissionsText.push('Edit Packing Lists'); // NEW
                if (user.canAccessTruckWaybills) permissionsText.push('Access Waybills');
                if (user.canEditTruckWaybills) permissionsText.push('Edit Waybills'); // NEW
                const displayPermissions = permissionsText.length > 0 ? `(${permissionsText.join(', ')})` : '(No document access)';

                listItem.innerHTML = `<span>${username} (${user.role}) ${displayPermissions}</span>`; // Display role and permissions
                listItem.style.cursor = 'pointer';
                listItem.style.color = 'var(--text-dark)';
                listItem.style.marginBottom = '5px';
                listItem.style.padding = '8px';
                listItem.style.borderBottom = '1px solid var(--border-color)';
                listItem.style.display = 'flex';
                listItem.style.justifyContent = 'space-between';
                listItem.style.alignItems = 'center';
                listItem.style.backgroundColor = 'var(--input-bg)';
                listItem.style.borderRadius = '5px';

                const actionsDiv = document.createElement('div');

                const editButton = document.createElement('button');
                editButton.textContent = 'Edit';
                editButton.classList.add('edit-btn');
                editButton.style.marginRight = '5px';
                editButton.onclick = (e) => {
                    e.stopPropagation(); // Prevent listItem click event
                    if (editingUsernameSpan && editUserContainer && editUserRoleSelect && editCanAccessInvoices && editCanEditInvoices && editCanAccessPackingLists && editCanEditPackingLists && editCanAccessTruckWaybills && editCanEditTruckWaybills) { // UPDATED
                        editingUsernameSpan.textContent = username;
                        editUserContainer.style.display = 'block';
                        editNewPasswordInput.value = ''; // Clear password fields
                        editConfirmPasswordInput.value = '';
                        editUserRoleSelect.value = user.role; // Set current role
                        editCanAccessInvoices.checked = user.canAccessInvoices;
                        editCanEditInvoices.checked = user.canEditInvoices; // NEW
                        editCanAccessPackingLists.checked = user.canAccessPackingLists;
                        editCanEditPackingLists.checked = user.canEditPackingLists; // NEW
                        editCanAccessTruckWaybills.checked = user.canAccessTruckWaybills;
                        editCanEditTruckWaybills.checked = user.canEditTruckWaybills; // NEW

                        // Disable role and permission changes for 'Medfarah' or if not admin editing another user
                        if (username === 'Medfarah' || currentUserPermissions.role !== 'admin') {
                            editUserRoleSelect.disabled = true;
                            editCanAccessInvoices.disabled = true;
                            editCanEditInvoices.disabled = true; // NEW
                            editCanAccessPackingLists.disabled = true;
                            editCanEditPackingLists.disabled = true; // NEW
                            editCanAccessTruckWaybills.disabled = true;
                            editCanEditTruckWaybills.disabled = true; // NEW
                        } else {
                            editUserRoleSelect.disabled = false;
                            editCanAccessInvoices.disabled = false;
                            editCanEditInvoices.disabled = false; // NEW
                            editCanAccessPackingLists.disabled = false;
                            editCanEditPackingLists.disabled = false; // NEW
                            editCanAccessTruckWaybills.disabled = false;
                            editCanEditTruckWaybills.disabled = false; // NEW
                        }
                    } else {
                        console.error("Editing user elements not found.");
                    }
                };
                actionsDiv.appendChild(editButton);

                // Add delete button only if admin and not deleting self
                if (currentUserPermissions.role === 'admin' && username !== loggedInUsername) {
                    const deleteButton = document.createElement('button');
                    deleteButton.textContent = 'Delete';
                    deleteButton.classList.add('delete-btn');
                    deleteButton.onclick = (e) => {
                        e.stopPropagation(); // Prevent listItem click event
                        showConfirmation(`Are you sure you want to delete user "${username}"?`, () => {
                            deleteUser(username);
                        });
                    };
                    actionsDiv.appendChild(deleteButton);
                }

                listItem.appendChild(actionsDiv);
                userListElement.appendChild(listItem);
            });

            if(editUserContainer) {
                 editUserContainer.style.display = 'none';
            }
        }

        // Function to handle password and role update
        function handlePasswordUpdate(event) {
            event.preventDefault();

            if (!editingUsernameSpan || !editNewPasswordInput || !editConfirmPasswordInput || !editUserRoleSelect || !editCanAccessInvoices || !editCanEditInvoices || !editCanAccessPackingLists || !editCanEditPackingLists || !editCanAccessTruckWaybills || !editCanEditTruckWaybills) { // UPDATED
                 console.error("Editing user form elements not found.");
                 return;
            }

            const usernameToEdit = editingUsernameSpan.textContent;
            const newPassword = editNewPasswordInput.value.trim();
            const confirmPassword = editConfirmPasswordInput.value.trim();
            const newRole = editUserRoleSelect.value;
            const canAccessInvoices = editCanAccessInvoices.checked;
            const canEditInvoices = editCanEditInvoices.checked; // NEW
            const canAccessPackingLists = editCanAccessPackingLists.checked;
            const canEditPackingLists = editCanEditPackingLists.checked; // NEW
            const canAccessTruckWaybills = editCanAccessTruckWaybills.checked;
            const canEditTruckWaybills = editCanEditTruckWaybills.checked; // NEW

            // If new password fields are not empty, validate them
            if (newPassword !== '' || confirmPassword !== '') {
                if (newPassword !== confirmPassword) {
                    showMessage('New password and confirm password do not match.', 'error');
                    return;
                }
            }

            // Update user data
            const currentUserData = users[usernameToEdit];
            if (newPassword !== '') {
                currentUserData.password = newPassword;
            }
            // Only allow admin to change roles and permissions, and prevent Medfarah's role/permissions from being changed by non-admin or self
            if (currentUserPermissions.role === 'admin') {
                if (usernameToEdit === 'Medfarah' && newRole !== 'admin') {
                    showMessage("The role of the primary admin 'Medfarah' cannot be changed.", 'error');
                    editUserRoleSelect.value = 'admin'; // Revert the select box
                    return;
                }
                currentUserData.role = newRole;
                currentUserData.canAccessInvoices = canAccessInvoices;
                currentUserData.canEditInvoices = canEditInvoices; // NEW
                currentUserData.canAccessPackingLists = canAccessPackingLists;
                currentUserData.canEditPackingLists = canEditPackingLists; // NEW
                currentUserData.canAccessTruckWaybills = canAccessTruckWaybills;
                currentUserData.canEditTruckWaybills = canEditTruckWaybills; // NEW
            } else if (usernameToEdit === loggedInUsername) {
                // Allow non-admin users to change their own password
                if (newPassword !== '') {
                    currentUserData.password = newPassword;
                }
                showMessage("You can only change your own password. Role and permissions cannot be changed.", 'error');
                return;
            } else {
                showMessage("You do not have permission to edit other users.", 'error');
                return;
            }


            saveUsers(users);

            showMessage(`User "${usernameToEdit}" updated successfully.`);

            if(editUserContainer) {
                editUserContainer.style.display = 'none';
            }
            drawUsers();
            // If the current user's permissions were changed, update the UI
            if (usernameToEdit === loggedInUsername) {
                currentUserPermissions = { ...users[loggedInUsername] };
                updateUIBasedOnRole();
                displayLoggedInUser();
            }
        }

        // Function to handle adding a new user
        function handleAddUser(event) {
            event.preventDefault();

            if (!newUsernameInput || !addPasswordInput || !addConfirmPasswordInput || !newUserRoleSelect || !addCanAccessInvoices || !addCanEditInvoices || !addCanAccessPackingLists || !addCanEditPackingLists || !addCanAccessTruckWaybills || !addCanEditTruckWaybills) { // UPDATED
                console.error("Add user form elements not found.");
                return;
            }

            const newUsername = newUsernameInput.value.trim();
            const newAddPassword = addPasswordInput.value.trim();
            const newAddConfirmPassword = addConfirmPasswordInput.value.trim();
            const newUserRole = newUserRoleSelect.value;
            const newCanAccessInvoices = addCanAccessInvoices.checked;
            const newCanEditInvoices = addCanEditInvoices.checked; // NEW
            const newCanAccessPackingLists = addCanAccessPackingLists.checked;
            const newCanEditPackingLists = addCanEditPackingLists.checked; // NEW
            const newCanAccessTruckWaybills = addCanAccessTruckWaybills.checked;
            const newCanEditTruckWaybills = addCanEditTruckWaybills.checked; // NEW

            if (newUsername === '') {
                showMessage('Username cannot be empty.', 'error');
                return;
            }

            if (users[newUsername]) {
                showMessage(`User "${newUsername}" already exists.`, 'error');
                return;
            }

            if (newAddPassword !== newAddConfirmPassword) {
                showMessage('Password and confirm password do not match.', 'error');
                return;
            }

            if (newAddPassword === '') {
                showMessage('Password cannot be empty.', 'error');
                return;
            }

            users[newUsername] = {
                password: newAddPassword,
                role: newUserRole,
                canAccessInvoices: newCanAccessInvoices,
                canEditInvoices: newCanEditInvoices, // NEW
                canAccessPackingLists: newCanAccessPackingLists,
                canEditPackingLists: newCanEditPackingLists, // NEW
                canAccessTruckWaybills: newCanAccessTruckWaybills,
                canEditTruckWaybills: newCanEditTruckWaybills // NEW
            };
            saveUsers(users);

            showMessage(`User "${newUsername}" added successfully.`);

            addUserForm.reset();
            // Reset checkboxes to default checked state for new user form
            addCanAccessInvoices.checked = true;
            addCanEditInvoices.checked = true; // NEW
            addCanAccessPackingLists.checked = true;
            addCanEditPackingLists.checked = true; // NEW
            addCanAccessTruckWaybills.checked = true;
            addCanEditTruckWaybills.checked = true; // NEW
            drawUsers();
        }

        // Function to delete a user
        function deleteUser(usernameToDelete) {
            if (currentUserPermissions.role !== 'admin') {
                showMessage('You do not have permission to delete users.', 'error');
                return;
            }
            if (usernameToDelete === loggedInUsername) {
                showMessage('You cannot delete your own account.', 'error');
                return;
            }
            if (usernameToDelete === 'Medfarah') {
                showMessage("The primary admin 'Medfarah' cannot be deleted.", 'error');
                return;
            }

            delete users[usernameToDelete];
            saveUsers(users);
            showMessage(`User "${usernameToDelete}" deleted successfully.`);
            drawUsers();
        }


        // Event listener for login form submission
        loginForm.addEventListener('submit', handleLogin);

        // Event listener for logout button click
        navLogoutButton.addEventListener('click', handleLogout);

        // Event listener for Manage Users button click
        if (navManageUsersButton) {
            navManageUsersButton.addEventListener('click', () => {
                 if (currentUserPermissions.role === 'admin') {
                    showView('manage-users-view');
                    drawUsers();
                } else {
                    showMessage('You do not have permission to access this page.', 'error');
                }
            });
        }

        // Event listener for password update form submission
        if (editUserForm) {
             editUserForm.addEventListener('submit', handlePasswordUpdate);
        }

        // Event listener for add user form submission
        if (addUserForm) {
            addUserForm.addEventListener('submit', handleAddUser);
        }

        // Event listener for cancel edit button
        if (cancelEditButton) {
            cancelEditButton.addEventListener('click', () => {
                 if(editUserContainer) {
                    editUserContainer.style.display = 'none';
                    if(editNewPasswordInput) editNewPasswordInput.value = '';
                    if(editConfirmPasswordInput) editConfirmPasswordInput.value = '';
                }
            });
        }


        // --- End Authentication and User Management Logic ---


        // Function to display messages (success or error)
        function showMessage(message, type = 'success') {
            if (!messageBox) {
                 console.error("Message box element not found.");
                 return;
            }
            messageBox.textContent = message;
            messageBox.className = `message-box ${type}`;
            messageBox.classList.remove('hidden');

            setTimeout(() => {
                 if (messageBox) {
                    messageBox.classList.add('hidden');
                 }
            }, 3000);
        }

        // Function to show a confirmation dialog
        function showConfirmation(message, onConfirm) {
            const confirmationBox = document.createElement('div');
            confirmationBox.id = 'confirmation-box';
            confirmationBox.style.position = 'fixed';
            confirmationBox.style.top = '50%';
            confirmationBox.style.left = '50%';
            confirmationBox.style.transform = 'translate(-50%, -50%)';
            confirmationBox.style.backgroundColor = 'var(--card-bg)';
            confirmationBox.style.color = 'var(--text-dark)';
            confirmationBox.style.padding = '25px';
            confirmationBox.style.borderRadius = '10px';
            confirmationBox.style.boxShadow = '0 6px 15px var(--shadow-medium)';
            confirmationBox.style.zIndex = '1001';
            confirmationBox.style.textAlign = 'center';
            confirmationBox.style.maxWidth = '90%';
            confirmationBox.style.border = '1px solid var(--border-color)';


            const messagePara = document.createElement('p');
            messagePara.textContent = message;
            messagePara.style.marginBottom = '20px';
            messagePara.style.fontSize = '1.1em';

            const confirmButton = document.createElement('button');
            confirmButton.textContent = 'Yes';
            confirmButton.style.marginRight = '10px';
            confirmButton.style.backgroundColor = 'var(--accent-green)';
            confirmButton.style.color = 'white';
            confirmButton.onclick = () => {
                onConfirm();
                document.body.removeChild(confirmationBox);
            };

            const cancelButton = document.createElement('button');
            cancelButton.textContent = 'No';
            cancelButton.style.backgroundColor = 'var(--accent-red)';
            cancelButton.style.color = 'white';
            cancelButton.onclick = () => {
                document.body.removeChild(confirmationBox);
            };

            confirmationBox.appendChild(messagePara);
            confirmationBox.appendChild(confirmButton);
            confirmationBox.appendChild(cancelButton);
            document.body.appendChild(confirmationBox);
        }


        // Generic save function for data
        function saveData(key, data) {
            try {
                localStorage.setItem(key, JSON.stringify(data.map(item => ({
                    ...item,
                    timestamp: item.timestamp instanceof Date ? item.timestamp.toISOString() : item.timestamp,
                    createdDate: item.createdDate || undefined // Ensure createdDate is saved if it exists
                }))));
            } catch (e) {
                console.error(`Error saving ${key} to local storage:`, e);
                showMessage(`Could not save ${key} data locally.`, 'error');
            }
        }

        // Generic load function for data
        function loadData(key) {
            try {
                const storedData = localStorage.getItem(key);
                if (storedData) {
                    return JSON.parse(storedData).map(item => ({
                        ...item,
                        timestamp: new Date(item.timestamp), // Convert timestamp back to Date
                        // Convert createdDate string to Date object if it exists
                        createdDate: item.createdDate ? item.createdDate : undefined
                    }));
                }
            } catch (e) {
                console.error(`Error loading ${key} from local storage:`, e);
                showMessage(`Could not load ${key} data from local storage.`, 'error');
            }
            return [];
        }

        function saveTransactions() { saveData('chassisTransactions', transactions); }
        function loadTransactions() { return loadData('chassisTransactions'); }
        function saveInvoices() { saveData('chassisInvoices', invoices); }
        function loadInvoices() { return loadData('chassisInvoices'); }
        function savePackingLists() { saveData('chassisPackingLists', packingLists); }
        function loadPackingLists() { return loadData('chassisPackingLists'); }
        function saveWaybills() { saveData('chassisWaybills', waybills); }
        function loadWaybills() { return loadData('chassisWaybills'); }
        function saveArchivedDocuments() { saveData('chassisArchivedDocuments', archivedDocuments); } /* NEW */
        function loadArchivedDocuments() { return loadData('chassisArchivedDocuments'); } /* NEW */


        // Function to generate a unique sequential ID with a prefix
        function generateSequentialId(prefix, existingIds) {
            let latestNumber = 0;
            existingIds.forEach(id => {
                if (id.startsWith(prefix)) {
                    const num = parseInt(id.substring(prefix.length), 10);
                    if (!isNaN(num) && num > latestNumber) {
                        latestNumber = num;
                    }
                }
            });
            return `${prefix}${(latestNumber + 1).toString().padStart(4, '0')}`;
        }

        // Function to show a specific view and hide others
        function showView(viewId) {
            // Check permissions for document views
            if (viewId === 'invoicing-view' && !currentUserPermissions.canAccessInvoices) {
                showMessage('You do not have permission to access Invoicing.', 'error');
                return;
            }
            if (viewId === 'packing-list-view' && !currentUserPermissions.canAccessPackingLists) {
                showMessage('You do not have permission to access Packing Lists.', 'error');
                return;
            }
            if (viewId === 'truck-waybill-view' && !currentUserPermissions.canAccessTruckWaybills) {
                showMessage('You do not have permission to access Truck Waybills.', 'error');
                return;
            }
            // Manage Users view is admin-only regardless of specific document permissions
            if (viewId === 'manage-users-view' && currentUserPermissions.role !== 'admin') {
                showMessage('You do not have permission to access this page.', 'error');
                return;
            }


            document.querySelectorAll('.view').forEach(view => {
                view.classList.remove('active');
            });
            const targetView = document.getElementById(viewId);
            if (targetView) {
                targetView.classList.add('active');
            }

            // Remove active class from all nav buttons
            document.querySelectorAll('#navigation button').forEach(btn => {
                btn.classList.remove('active-nav');
            });
            // Add active class to the clicked nav button
            const activeNavButton = document.getElementById(`nav-${viewId.replace('-view', '')}`);
            if (activeNavButton) {
                activeNavButton.classList.add('active-nav');
            }


            // Redraw content for the active view
            if (viewId === 'inventory-view') {
                drawInventory();
            } else if (viewId === 'history-view') {
                drawHistory();
                updateHistoryYardSummary(); // NEW: Update yard summary when history view is shown
            } else if (viewId === 'invoicing-view') {
                drawInvoices();
                resetInvoiceForm();
            } else if (viewId === 'packing-list-view') {
                drawPackingLists();
                resetPackingListForm();
            } else if (viewId === 'truck-waybill-view') {
                drawWaybills();
                resetWaybillForm();
            } else if (viewId === 'document-archive-view') { /* NEW */
                drawArchivedDocuments();
                resetArchiveDocumentForm();
            } else if (viewId === 'dashboard-view') {
                updateDashboard();
                updateCharts();
            }

            currentSearchTerm = '';
            if(chassisSearchInput) chassisSearchInput.value = '';
        }

        // Function to get the list of currently checked-in chassis
        function getCurrentInventory() {
            const latestStatusMap = new Map();

            for (let i = transactions.length - 1; i >= 0; i--) {
                const transaction = transactions[i];
                if (!latestStatusMap.has(transaction.chassisNumber)) {
                    latestStatusMap.set(transaction.chassisNumber, transaction);
                }
            }

            const currentInventory = [];
            for (const [chassisNumber, transaction] of latestStatusMap.entries()) {
                if (transaction.type === 'check-in') {
                    currentInventory.push({
                        chassisNumber: transaction.chassisNumber,
                        status: 'In Stock',
                        customer: transaction.customerName || 'N/A',
                        billOfLading: transaction.billOfLading || 'N/A',
                        checkinDate: transaction.timestamp.toISOString(),
                        checkoutDate: '',
                        remarque: transaction.remarque || 'No remarque'
                    });
                } else if (transaction.type === 'check-out') {
                    currentInventory.push({
                        chassisNumber: transaction.chassisNumber,
                        status: 'Out of Stock',
                        customer: transaction.customerName || 'N/A',
                        billOfLading: transaction.billOfLading || 'N/A',
                        checkinDate: '',
                        checkoutDate: transaction.timestamp.toISOString(),
                        remarque: transaction.remarque || 'No remarque'
                    });
                }
            }
            return currentInventory.filter(c => c.status === 'In Stock');
        }


        // --- NEW CANVAS VISUALIZATION FUNCTIONS (Integrated) ---

        /**
         * Returns a color based on chassis status for the yard visualization.
         * @param {string} status - The status of the chassis.
         * @returns {string} Hex color code.
         */
        function getChassisStatusColor(status) {
            switch (status) {
                case 'In Stock':
                    return '#50fa7b'; // Green
                case 'Out of Stock':
                    return '#ff5555'; // Red
                case 'Awaiting Shipment':
                    return '#ffb86c'; // Orange
                default:
                    return '#9E9E9E'; // Grey for unknown status
            }
        }

        /**
         * Calculates the dimensions of each spot and chassis based on canvas size.
         * @returns {object} Contains spotWidth, spotHeight, and chassisRadius.
         */
        function calculateDimensions() {
            const totalSpotWidth = chassisYardCanvas.width / YARD_COLS;
            const totalSpotHeight = chassisYardCanvas.height / YARD_ROWS;

            const spotWidth = totalSpotWidth - SPOT_PADDING;
            const spotHeight = totalSpotHeight - SPOT_PADDING;

            const chassisRadius = Math.min(spotWidth, spotHeight) * CHASSIS_RADIUS_RATIO;

            return { spotWidth, spotHeight, chassisRadius };
        }

        /**
         * Draws the entire yard visualization based on provided inventory data.
         * @param {Array<Object>} currentActiveInventory - Array of chassis objects currently "in yard".
         */
        function drawYard(currentActiveInventory) {
            if (!ctxChassisYard) return;

            ctxChassisYard.clearRect(0, 0, chassisYardCanvas.width, chassisYardCanvas.height);

            const { spotWidth, spotHeight, chassisRadius } = calculateDimensions();

            const tempYardMap = Array(YARD_ROWS * YARD_COLS).fill(null);
            currentActiveInventory.forEach((chassis, index) => {
                if (index < tempYardMap.length) {
                    tempYardMap[index] = chassis;
                }
            });

            for (let i = 0; i < YARD_ROWS; i++) {
                for (let j = 0; j < YARD_COLS; j++) {
                    const index = i * YARD_COLS + j;
                    const x = j * (spotWidth + SPOT_PADDING) + SPOT_PADDING / 2;
                    const y = i * (spotHeight + SPOT_PADDING) + SPOT_PADDING / 2;

                    // Draw spot rectangle
                    ctxChassisYard.fillStyle = '#CFD8DC';
                    ctxChassisYard.fillRect(x, y, spotWidth, spotHeight);
                    ctxChassisYard.strokeStyle = '#90A4AE';
                    ctxChassisYard.lineWidth = 1;
                    ctxChassisYard.strokeRect(x, y, spotWidth, spotHeight);

                    const chassis = tempYardMap[index];
                    if (chassis) {
                        // Draw chassis (circle for simplicity)
                        ctxChassisYard.beginPath();
                        const centerX = x + spotWidth / 2;
                        const centerY = y + spotHeight / 2;
                        ctxChassisYard.arc(centerX, centerY, chassisRadius, 0, Math.PI * 2);
                        ctxChassisYard.fillStyle = getChassisStatusColor(chassis.status);
                        ctxChassisYard.fill();
                        ctxChassisYard.strokeStyle = '#424242';
                        ctxChassisYard.lineWidth = 1;
                        ctxChassisYard.stroke();

                        // Draw chassis number (simplified)
                        ctxChassisYard.fillStyle = 'white';
                        ctxChassisYard.font = `${Math.max(8, chassisRadius * 0.7)}px Arial`;
                        ctxChassisYard.textAlign = 'center';
                        ctxChassisYard.textBaseline = 'middle';
                        const displayChassisNumber = chassis.chassisNumber.startsWith('CH') ? chassis.chassisNumber.replace('CH', '') : chassis.chassisNumber;
                        ctxChassisYard.fillText(displayChassisNumber, centerX, centerY);
                    }
                }
            }
        }

        /**
         * Handles clicks on the canvas to display chassis details.
         * @param {MouseEvent} event - The click event.
         */
        function handleCanvasClick(event) {
            if (!ctxChassisYard) return;

            const rect = chassisYardCanvas.getBoundingClientRect();
            const scaleX = chassisYardCanvas.width / rect.width;
            const scaleY = chassisYardCanvas.height / rect.height;

            const mouseX = (event.clientX - rect.left) * scaleX;
            const mouseY = (event.clientY - rect.top) * scaleY;

            const { spotWidth, spotHeight } = calculateDimensions();

            const currentActiveInventory = getCurrentInventory();
            const tempYardMap = Array(YARD_COLS * YARD_ROWS).fill(null); // Corrected size
            currentActiveInventory.forEach((chassis, index) => {
                // Ensure index is within bounds of tempYardMap
                if (index < tempYardMap.length) {
                    tempYardMap[index] = chassis;
                }
            });

            for (let i = 0; i < YARD_ROWS; i++) {
                for (let j = 0; j < YARD_COLS; j++) {
                    const x = j * (spotWidth + SPOT_PADDING) + SPOT_PADDING / 2;
                    const y = i * (spotHeight + SPOT_PADDING) + SPOT_PADDING / 2;

                    if (mouseX >= x && mouseX <= x + spotWidth &&
                        mouseY >= y && mouseY <= y + spotHeight) {
                        const index = i * YARD_COLS + j;
                        const clickedChassis = tempYardMap[index];
                        if (clickedChassis) {
                            displayChassisDetails(clickedChassis);
                        } else {
                            hideChassisDetails();
                        }
                        return;
                    }
                }
            }
            hideChassisDetails();
        }

        /**
         * Displays the details of a given chassis in the details box.
         * @param {object} chassis - The chassis object to display.
         */
        function displayChassisDetails(chassis) {
            document.getElementById('detail-chassis-number').textContent = chassis.chassisNumber || 'N/A';
            document.getElementById('detail-status').textContent = chassis.status || 'N/A';
            document.getElementById('detail-customer').textContent = chassis.customer || 'N/A';
            document.getElementById('detail-bill-of-lading').textContent = chassis.billOfLading || 'N/A';
            document.getElementById('detail-checkin-date').textContent = chassis.checkinDate ? new Date(chassis.checkinDate).toLocaleDateString() : 'N/A';
            document.getElementById('detail-checkout-date').textContent = chassis.checkoutDate ? new Date(chassis.checkoutDate).toLocaleDateString() : 'N/A';
            document.getElementById('detail-remarque').textContent = chassis.remarque || 'No remarque';
            detailsBox.style.display = 'block';
        }

        /**
         * Hides the chassis details box.
         */
        function hideChassisDetails() {
            detailsBox.style.display = 'none';
        }

        // --- Event Listeners for new Canvas ---
        if (chassisYardCanvas) {
            chassisYardCanvas.addEventListener('click', handleCanvasClick);
        }
        if (closeDetailsBtn) {
            closeDetailsBtn.addEventListener('click', hideChassisDetails);
        }

        // --- Responsive Canvas and Initial Draw ---
        function resizeCanvas() {
            if (inventoryView && inventoryView.classList.contains('active') && chassisYardCanvas) {
                const container = document.getElementById('inventory-view');
                // Calculate canvas dimensions based on container width and desired aspect ratio
                // (YARD_COLS / YARD_ROWS) * 1.05 for a slight buffer
                chassisYardCanvas.style.width = '100%';
                chassisYardCanvas.style.height = `${container.offsetWidth / (YARD_COLS / YARD_ROWS) * 0.75}px`; // Adjusted ratio for better fit
                chassisYardCanvas.width = chassisYardCanvas.offsetWidth;
                chassisYardCanvas.height = chassisYardCanvas.offsetHeight;
                drawInventory();
            }
        }

        // --- END NEW CANVAS VISUALIZATION FUNCTIONS ---


        // Function to draw the current inventory on the canvas and update counts and breakdown
        function drawInventory() {
            let totalCheckIns = 0;
            let totalCheckOuts = 0;
            const billOfLadingCounts = {};

            transactions.forEach(transaction => {
                if (transaction.type === 'check-in') {
                    totalCheckIns++;
                    const bol = transaction.billOfLading || 'No BOL';
                    if (!billOfLadingCounts[bol]) {
                        billOfLadingCounts[bol] = { in: 0, out: 0 };
                    }
                    billOfLadingCounts[bol].in++;
                } else if (transaction.type === 'check-out') {
                    totalCheckOuts++;
                    const associatedCheckIn = transactions.slice().reverse().find(t =>
                        t.chassisNumber === transaction.chassisNumber && t.type === 'check-in' && t.timestamp < transaction.timestamp
                    );
                    const bol = associatedCheckIn ? (associatedCheckIn.billOfLading || 'No BOL') : 'No BOL (Check-out without prior Check-in)';
                     if (!billOfLadingCounts[bol]) {
                         billOfLadingCounts[bol] = { in: 0, out: 0 };
                     }
                    billOfLadingCounts[bol].out++;
                }
            });

            if(totalCheckedInElement) totalCheckedInElement.textContent = totalCheckIns;
            if(totalCheckedOutElement) totalCheckedOutElement.textContent = totalCheckOuts;

            if(billOfLadingListElement) billOfLadingListElement.innerHTML = '';

            if(billOfLadingListElement) {
                const sortedBOLs = Object.keys(billOfLadingCounts).sort();
                sortedBOLs.forEach(bol => {
                    const counts = billOfLadingCounts[bol];
                    const listItem = document.createElement('li');
                    listItem.innerHTML = `<strong>${bol}:</strong> Checked In: ${counts.in}, Checked Out: ${counts.out}`;
                    billOfLadingListElement.appendChild(listItem);
                });

                if (sortedBOLs.length === 0 && transactions.length > 0) {
                     const listItem = document.createElement('li');
                     listItem.textContent = 'No Bill of Lading data available in transactions.';
                     billOfLadingListElement.appendChild(listItem);
                } else if (transactions.length === 0) {
                     const listItem = document.createElement('li');
                     listItem.textContent = 'No transaction data available.';
                     billOfLadingListElement.appendChild(listItem);
                }
            }

            drawYard(getCurrentInventory());
        }


        // Function to draw the transaction history table
        function drawHistory(searchTerm = '') {
            if (!historyTableBody) {
                 console.error("History table body element not found.");
                 return;
            }

            historyTableBody.innerHTML = '';
            const lowerCaseSearchTerm = searchTerm.toLowerCase();

            const filteredTransactions = transactions.filter(transaction => {
                const chassisMatch = transaction.chassisNumber.toLowerCase().includes(lowerCaseSearchTerm);
                const bolMatch = (transaction.billOfLading || '').toLowerCase().includes(lowerCaseSearchTerm);
                const customerMatch = (transaction.customerName || '').toLowerCase().includes(lowerCaseSearchTerm); // NEW: Search by customer name
                return chassisMatch || bolMatch || customerMatch; // Combine all search criteria
            });

            filteredTransactions.sort((a, b) => b.timestamp - a.timestamp);

            filteredTransactions.forEach((transaction) => {
                const row = historyTableBody.insertRow();
                const dateTimeString = transaction.timestamp.toLocaleString();

                row.insertCell(0).textContent = transaction.chassisNumber;
                row.insertCell(1).textContent = transaction.type;
                row.insertCell(2).textContent = transaction.customerName || '';
                row.insertCell(3).textContent = transaction.billOfLading || '';
                row.insertCell(4).textContent = dateTimeString;
                row.insertCell(5).textContent = transaction.remarque || '';

                if (currentUserPermissions.role === 'admin') {
                    const actionsCell = row.insertCell(6);
                    const deleteButton = document.createElement('button');
                    deleteButton.textContent = 'Delete';
                    deleteButton.classList.add('delete-btn');
                    deleteButton.onclick = () => showConfirmation('Are you sure you want to delete this transaction?', () => {
                        const originalTransactionIndex = transactions.findIndex(t =>
                            t.chassisNumber === transaction.chassisNumber &&
                            t.type === transaction.type &&
                            t.timestamp.getTime() === transaction.timestamp.getTime()
                        );
                        if (originalTransactionIndex !== -1) {
                            deleteTransaction(originalTransactionIndex);
                        } else {
                            console.error("Transaction not found for deletion.");
                            showMessage("Error: Transaction not found for deletion.", 'error');
                        }
                    });
                    actionsCell.appendChild(deleteButton);
                }
            });
        }

        // Function to delete a transaction
        function deleteTransaction(originalIndex) {
            if (currentUserPermissions.role !== 'admin') {
                showMessage('You do not have permission to delete transactions.', 'error');
                return;
            }

            transactions.splice(originalIndex, 1);
            saveTransactions();
            drawHistory(currentSearchTerm);
            showMessage('Transaction deleted successfully.');
            updateDashboard();
            drawInventory();
            updateCharts();
            updateHistoryYardSummary(); // NEW: Update yard summary after deletion
        }


        // Event listener for the Check-In form submission
        if (checkinForm) {
            checkinForm.addEventListener('submit', (event) => {
                event.preventDefault();

                const chassisNumber = document.getElementById('checkinChassisNumber').value.trim();
                const billOfLading = checkinBillOfLadingInput.value.trim();
                const remarque = checkinRemarqueInput.value.trim();

                const currentInventoryNumbers = getCurrentInventory().map(c => c.chassisNumber);
                if (currentInventoryNumbers.includes(chassisNumber)) {
                    showMessage(`Chassis ${chassisNumber} is already checked in.`, 'error');
                    return;
                }

                const newTransaction = {
                    chassisNumber: chassisNumber,
                    type: 'check-in',
                    customerName: '',
                    billOfLading: billOfLading,
                    remarque: remarque,
                    timestamp: new Date()
                };

                transactions.unshift(newTransaction);
                saveTransactions();
                checkinForm.reset();
                showMessage(`Chassis ${chassisNumber} checked in successfully.`);
                drawInventory();
                drawHistory();
                updateDashboard();
                updateCharts();
                updateHistoryYardSummary(); // NEW: Update yard summary after check-in
            });
        }


        // Event listener for the Check-Out form submission
        if (checkoutForm) {
            checkoutForm.addEventListener('submit', (event) => {
                event.preventDefault();

                const chassisNumber = document.getElementById('checkoutChassisNumber').value.trim();
                const customerName = document.getElementById('checkoutCustomerName').value.trim();
                const remarque = checkoutRemarqueInput.value.trim();


                const currentInventoryNumbers = getCurrentInventory().map(c => c.chassisNumber);
                if (!currentInventoryNumbers.includes(chassisNumber)) {
                    showMessage(`Chassis ${chassisNumber} is not currently checked in.`, 'error');
                    return;
                }

                const newTransaction = {
                    chassisNumber: chassisNumber,
                    type: 'check-out',
                    customerName: customerName,
                    billOfLading: '',
                    remarque: remarque,
                    timestamp: new Date()
                };

                transactions.unshift(newTransaction);
                saveTransactions();
                checkoutForm.reset();
                showMessage(`Chassis ${chassisNumber} checked out successfully by ${customerName}.`);
                drawInventory();
                drawHistory();
                updateDashboard();
                updateCharts();
                updateHistoryYardSummary(); // NEW: Update yard summary after check-out
            });
        }


        // Event listeners for navigation buttons
        if (navDashboard) navDashboard.addEventListener('click', () => showView('dashboard-view'));
        if (navCheckin) navCheckin.addEventListener('click', () => showView('checkin-view'));
        if (navCheckout) navCheckout.addEventListener('click', () => showView('checkout-view'));
        if (navInventory) navInventory.addEventListener('click', () => showView('inventory-view'));
        if (navHistory) navHistory.addEventListener('click', () => showView('history-view'));
        if (navInvoicing) navInvoicing.addEventListener('click', () => showView('invoicing-view'));
        if (navPackingList) navPackingList.addEventListener('click', () => showView('packing-list-view'));
        if (navTruckWaybill) navTruckWaybill.addEventListener('click', () => showView('truck-waybill-view'));
        if (navDocumentArchive) navDocumentArchive.addEventListener('click', () => showView('document-archive-view')); /* NEW */


        // Event listener for the Export History button
        if (exportHistoryButton) {
            exportHistoryButton.addEventListener('click', () => {
                const wb = XLSX.utils.book_new();
                const data = [
                    ['Chassis Number', 'Status', 'Customer', 'Bill of Lading', 'Date/Time', 'Remarque']
                ];
                transactions.forEach(transaction => {
                    data.push([
                        transaction.chassisNumber,
                        transaction.type,
                        transaction.customerName || '',
                        transaction.billOfLading || '',
                        transaction.timestamp.toLocaleString(),
                        transaction.remarque || ''
                    ]);
                });
                const ws = XLSX.utils.aoa_to_sheet(data);
                XLSX.utils.book_append_sheet(wb, ws, 'Transaction History');
                XLSX.writeFile(wb, 'chassis_history.xlsx');
                showMessage('History exported to Excel.');
            });
        }


        // Event listener for the Import Excel file input
        if (importExcelInput) {
            importExcelInput.addEventListener('change', (event) => {
                if (currentUserPermissions.role !== 'admin') {
                    showMessage('You do not have permission to import data.', 'error');
                    event.target.value = null;
                    return;
                }

                const file = event.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        try {
                            const data = new Uint8Array(e.target.result);
                            const workbook = XLSX.read(data, { type: 'array' });
                            const sheetName = workbook.SheetNames[0];
                            const worksheet = workbook.Sheets[sheetName];

                            const importedRawData = XLSX.utils.sheet_to_json(worksheet, { header: 1 });

                            if (importedRawData.length < 1) {
                                showMessage('Empty Excel file or no data found.', 'error');
                                return;
                            }

                            const headers = importedRawData[0].map(h => String(h).trim());

                            const expectedColumns = {
                                'chassisNumber': ['chassis number', 'chassis'],
                                'type': ['status', 'type'],
                                'customerName': ['customer', 'customer name'],
                                'billOfLading': ['bill of lading', 'bol'],
                                'timestamp': ['date/time', 'timestamp', 'date', 'time'],
                                'remarque': ['remarque', 'notes', 'remarks']
                            };

                            const columnMapping = {};
                            for (const key in expectedColumns) {
                                const possibleNames = expectedColumns[key];
                                for (let i = 0; i < headers.length; i++) {
                                    if (possibleNames.includes(headers[i].toLowerCase())) {
                                        columnMapping[key] = i;
                                        break;
                                    }
                                }
                            }

                            const requiredColumns = ['chassisNumber', 'type', 'timestamp'];
                            for (const col of requiredColumns) {
                                if (columnMapping[col] === undefined) {
                                    showMessage(`Missing required column: "${expectedColumns[col][0]}" in the Excel file. Please ensure all necessary columns are present.`, 'error');
                                    return;
                                }
                            }

                            const importedTransactions = importedRawData.slice(1).map(row => {
                                const transaction = {};

                                const chassisVal = row[columnMapping.chassisNumber];
                                transaction.chassisNumber = chassisVal ? String(chassisVal).trim() : '';

                                const typeVal = row[columnMapping.type];
                                transaction.type = typeVal ? String(typeVal).trim().toLowerCase() : '';

                                const customerVal = row[columnMapping.customerName];
                                transaction.customerName = customerVal ? String(customerVal).trim() : '';

                                const bolVal = row[columnMapping.billOfLading];
                                transaction.billOfLading = bolVal ? String(bolVal).trim() : '';

                                const remarqueVal = row[columnMapping.remarque];
                                transaction.remarque = remarqueVal ? String(remarqueVal).trim() : '';

                                const timestampVal = row[columnMapping.timestamp];
                                let parsedDate = null;
                                if (timestampVal) {
                                    if (typeof timestampVal === 'number') {
                                        try {
                                            const dateObj = XLSX.SSF.parse_date_code(timestampVal);
                                            parsedDate = new Date(dateObj.y, dateObj.m - 1, dateObj.d, dateObj.H, dateObj.M, dateObj.S);
                                        } catch (dateError) {
                                            console.warn("Failed to parse numeric date:", dateError);
                                        }
                                    }
                                    if (!parsedDate) {
                                        parsedDate = new Date(String(timestampVal));
                                    }
                                }
                                transaction.timestamp = parsedDate instanceof Date && !isNaN(parsedDate) ? parsedDate : new Date();

                                return transaction;
                            }).filter(transaction =>
                                transaction.chassisNumber &&
                                (transaction.type === 'check-in' || transaction.type === 'check-out') &&
                                transaction.timestamp instanceof Date && !isNaN(transaction.timestamp)
                            );

                            const newTransactions = [];
                            importedTransactions.forEach(impTx => {
                                const isDuplicate = transactions.some(extTx =>
                                    extTx.chassisNumber === impTx.chassisNumber &&
                                    extTx.type === impTx.type &&
                                    extTx.timestamp.getTime() === impTx.timestamp.getTime() &&
                                    extTx.customerName === impTx.customerName &&
                                    extTx.billOfLading === impTx.billOfLading &&
                                    extTx.remarque === impTx.remarque
                                );

                                if (!isDuplicate) {
                                    newTransactions.push(impTx);
                                }
                            });

                            transactions = [...newTransactions, ...transactions];
                            transactions.sort((a, b) => b.timestamp - a.timestamp);

                            saveTransactions();
                            drawHistory();
                            showMessage('History imported successfully.');
                            updateDashboard();
                            drawInventory();
                            updateCharts();
                            updateHistoryYardSummary(); // NEW: Update yard summary after import
                        } catch (e) {
                            console.error('Error importing Excel file:', e);
                            showMessage('Error importing Excel file. Please ensure it is a valid .xlsx or .xls file and follows the expected column structure. (Chassis Number, Status, Date/Time are essential)', 'error');
                        } finally {
                            event.target.value = null;
                        }
                    };
                    reader.readAsArrayBuffer(file);
                }
            });
        }


        // Event listener for the search button click
        if (searchChassisButton) {
            searchChassisButton.addEventListener('click', () => {
                currentSearchTerm = chassisSearchInput ? chassisSearchInput.value.trim() : '';
                drawHistory(currentSearchTerm);
            });
        }


        // Event listener for pressing Enter in the search input field
        if (chassisSearchInput) {
            chassisSearchInput.addEventListener('keypress', (event) => {
                if (event.key === 'Enter') {
                    event.preventDefault();
                    if(searchChassisButton) searchChassisButton.click();
                }
            });
        }


        // Event listener for the Print History button
        if (printHistoryButton) {
            printHistoryButton.addEventListener('click', () => {
                window.print();
            });
        }


        // Initial draw and redraw on window resize (Modified to call global resizeCanvas)
        window.addEventListener('load', () => {
            resizeCanvas();
        });
        window.addEventListener('resize', resizeCanvas);


        // --- Invoicing Functions ---

        // Function to add a new item row to the invoice form
        function addInvoiceItemRow(item = {}) {
            const itemDiv = document.createElement('div');
            itemDiv.classList.add('invoice-item-row');
            itemDiv.innerHTML = `
                <input type="text" class="item-chassis-number" placeholder="Chassis No." value="${item.chassisNumber || ''}" required>
                <input type="text" class="item-description" placeholder="Description (e.g., DUMP TRUCK)" value="${item.description || 'DUMP TRUCK'}" required>
                <input type="number" class="item-qty" placeholder="Qty" value="${item.qty || 1}" min="1" required>
                <input type="number" class="item-volume" placeholder="Volume (CBM)" step="0.01" value="${item.volume || ''}">
                <input type="number" class="item-unit-price" placeholder="Unit Price (USD)" step="0.01" value="${item.unitPrice || ''}" required>
                <input type="number" class="item-total-price" placeholder="Total Price" readonly style="background-color: var(--input-bg); color: var(--text-dark);" value="${item.totalPrice || ''}">
                <button type="button" class="delete-btn remove-item-btn">-</button>
            `;
            invoiceItemsContainer.appendChild(itemDiv);

            const qtyInput = itemDiv.querySelector('.item-qty');
            const unitPriceInput = itemDiv.querySelector('.item-unit-price');
            const totalPriceInput = itemDiv.querySelector('.item-total-price');
            const removeButton = itemDiv.querySelector('.remove-item-btn');

            const calculateRowTotal = () => {
                const qty = parseFloat(qtyInput.value) || 0;
                const unitPrice = parseFloat(unitPriceInput.value) || 0;
                totalPriceInput.value = (qty * unitPrice).toFixed(2);
                calculateGrandTotal();
            };

            qtyInput.addEventListener('input', calculateRowTotal);
            unitPriceInput.addEventListener('input', calculateRowTotal);
            removeButton.addEventListener('click', () => {
                itemDiv.remove();
                calculateGrandTotal();
            });

            calculateRowTotal();
        }

        // Function to calculate the grand total of the invoice
        function calculateGrandTotal() {
            let grandTotal = 0;
            document.querySelectorAll('.invoice-item-row .item-total-price').forEach(input => {
                grandTotal += parseFloat(input.value) || 0;
            });
            invoiceGrandTotalInput.value = grandTotal.toFixed(2);
        }

        // Resets the invoice form to its initial state for new entry
        function resetInvoiceForm() {
            invoiceForm.reset();
            invoiceItemsContainer.innerHTML = '';
            addInvoiceItemRow();
            invoiceNoInput.value = generateSequentialId('HJF-INV-', invoices.map(inv => inv.invoiceNo));
            invoiceCreatedDateInput.valueAsDate = new Date(); // Set to current date
            invoicePortLoadingInput.value = 'DJIBOUTI FREE ZONE';
            invoicePortDischargeInput.value = 'ADDIS ABABA, ETHIOPIA';
            invoiceShipment.value = 'SELF DRIVE';
            invoiceTermsPayment.value = 'LC';
            invoiceBank.value = 'CAC INTERNATIONAL BANK';
            invoiceAccountNo.value = '1003471115';
            invoiceSwift.value = 'CACDDJJD';

            submitInvoiceBtn.textContent = 'Create Invoice';
            cancelInvoiceEditBtn.style.display = 'none';
            generateInvoicePrintButton.style.display = 'none';
            currentEditingInvoice = null;
        }

        // Function to populate invoice form for editing
        function editInvoice(invoice) {
            if (currentUserPermissions.role !== 'admin' && !currentUserPermissions.canEditInvoices) {
                showMessage('You do not have permission to edit commercial invoices.', 'error');
                return;
            }
            currentEditingInvoice = invoice;
            showView('invoicing-view');

            invoiceNoInput.value = invoice.invoiceNo;
            invoiceCreatedDateInput.value = invoice.createdDate || ''; // Populate createdDate
            invoiceLcNumberInput.value = invoice.lcNumber || '';
            invoiceTinNumberInput.value = invoice.tinNumber || '';
            invoiceProformaNumberInput.value = invoice.proformaNumber || '';
            invoiceProformaDateInput.value = invoice.proformaDate || '';
            invoiceNotify.value = invoice.notify || '';
            invoiceConsignee.value = invoice.consignee || '';
            invoicePortLoadingInput.value = invoice.portLoading || 'DJIBOUTI FREE ZONE';
            invoicePortDischargeInput.value = invoice.portDischarge || 'ADDIS ABABA, ETHIOPIA';
            invoiceShipment.value = invoice.shipment || 'SELF DRIVE';
            invoiceTermsPayment.value = invoice.termsPayment || 'LC';
            invoiceBank.value = invoice.bank || 'CAC INTERNATIONAL BANK';
            invoiceAccountNo.value = invoice.accountNo || '1003471115';
            invoiceSwift.value = invoice.swift || 'CACDDJJD';
            invoiceGrandTotalInput.value = invoice.grandTotal.toFixed(2);

            invoiceItemsContainer.innerHTML = '';
            invoice.items.forEach(item => addInvoiceItemRow(item));

            submitInvoiceBtn.textContent = 'Update Invoice';
            cancelInvoiceEditBtn.style.display = 'inline-block';
            generateInvoicePrintButton.style.display = 'inline-block';
            generateInvoicePrintButton.onclick = () => generateInvoicePrintHTML(invoice);
        }


        // Event listener for adding invoice item
        if (addInvoiceItemButton) {
            addInvoiceItemButton.addEventListener('click', () => addInvoiceItemRow());
        }

        // Event listener for invoice form submission
        if (invoiceForm) {
            invoiceForm.addEventListener('submit', (event) => {
                event.preventDefault();

                const invoiceNo = invoiceNoInput.value.trim();
                const createdDate = invoiceCreatedDateInput.value; // Get createdDate
                const lcNumber = invoiceLcNumberInput.value.trim();
                const tinNumber = invoiceTinNumberInput.value.trim();
                const proformaNumber = invoiceProformaNumberInput.value.trim();
                const proformaDate = invoiceProformaDateInput.value.trim();
                const notify = invoiceNotify.value.trim();
                const consignee = invoiceConsignee.value.trim();
                const portLoading = invoicePortLoadingInput.value.trim();
                const portDischarge = invoicePortDischargeInput.value.trim();
                const shipment = invoiceShipment.value.trim();
                const termsPayment = invoiceTermsPayment.value.trim();
                const bank = invoiceBank.value.trim();
                const accountNo = invoiceAccountNo.value.trim();
                const swift = invoiceSwift.value.trim();
                const grandTotal = parseFloat(invoiceGrandTotalInput.value);

                const items = [];
                let hasEmptyItemField = false;
                document.querySelectorAll('.invoice-item-row').forEach(row => {
                    const chassisNumber = row.querySelector('.item-chassis-number').value.trim();
                    const description = row.querySelector('.item-description').value.trim();
                    const qty = parseFloat(row.querySelector('.item-qty').value);
                    const volume = parseFloat(row.querySelector('.item-volume').value) || 0;
                    const unitPrice = parseFloat(row.querySelector('.item-unit-price').value);
                    const totalPrice = parseFloat(row.querySelector('.item-total-price').value);

                    if (!chassisNumber || !description || isNaN(qty) || isNaN(unitPrice)) {
                        hasEmptyItemField = true;
                        return;
                    }
                    items.push({ chassisNumber, description, qty, volume, unitPrice, totalPrice });
                });

                if (hasEmptyItemField) {
                    showMessage('Please fill in all required fields for invoice items.', 'error');
                    return;
                }

                if (items.length === 0) {
                     showMessage('Please add at least one item to the invoice.', 'error');
                     return;
                }


                const newInvoiceData = {
                    invoiceNo,
                    createdDate, // Store createdDate
                    lcNumber,
                    tinNumber,
                    proformaNumber,
                    proformaDate,
                    notify,
                    consignee,
                    portLoading,
                    portDischarge,
                    shipment,
                    termsPayment,
                    bank,
                    accountNo,
                    swift,
                    items,
                    grandTotal,
                    timestamp: currentEditingInvoice ? currentEditingInvoice.timestamp : new Date()
                };

                if (currentEditingInvoice) {
                    const index = invoices.findIndex(inv => inv.invoiceNo === currentEditingInvoice.invoiceNo);
                    if (index !== -1) {
                        invoices[index] = newInvoiceData;
                        showMessage(`Invoice ${invoiceNo} updated successfully.`);
                    } else {
                        invoices.unshift(newInvoiceData);
                        showMessage(`Invoice ${invoiceNo} created successfully (as update failed to find original).`);
                    }
                    currentEditingInvoice = null;
                } else {
                    if (invoices.some(inv => inv.invoiceNo === invoiceNo)) {
                        showMessage(`Invoice No. ${invoiceNo} already exists.`, 'error');
                        return;
                    }
                    invoices.unshift(newInvoiceData);
                    showMessage(`Invoice ${invoiceNo} created successfully.`);
                }

                saveInvoices();
                resetInvoiceForm();
                drawInvoices();
                updateDashboard();
                updateCharts();
                generateInvoicePrintButton.style.display = 'inline-block';
                generateInvoicePrintButton.onclick = () => generateInvoicePrintHTML(newInvoiceData);
            });
        }

        // Event listener for Invoice Cancel Edit button
        if (cancelInvoiceEditBtn) {
            cancelInvoiceEditBtn.addEventListener('click', resetInvoiceForm);
        }

        // Function to draw invoices table
        function drawInvoices() {
            if (!invoicesTableBody) return;
            invoicesTableBody.innerHTML = '';

            invoices.sort((a, b) => b.timestamp - a.timestamp);

            invoices.forEach((invoice, index) => {
                const row = invoicesTableBody.insertRow();
                row.insertCell(0).textContent = invoice.invoiceNo;
                row.insertCell(1).textContent = invoice.consignee || 'N/A';
                row.insertCell(2).textContent = `$${invoice.grandTotal.toFixed(2)}`;
                row.insertCell(3).textContent = invoice.createdDate || invoice.timestamp.toLocaleDateString(); // Display createdDate
                const actionsCell = row.insertCell(4);

                const viewButton = document.createElement('button');
                viewButton.textContent = 'View/Print';
                viewButton.classList.add('generate-doc-btn');
                viewButton.onclick = () => generateInvoicePrintHTML(invoice);
                actionsCell.appendChild(viewButton);

                if (currentUserPermissions.role === 'admin' || currentUserPermissions.canEditInvoices) { // Allow edit if admin or has specific permission
                    const editButton = document.createElement('button');
                    editButton.textContent = 'Edit';
                    editButton.classList.add('edit-btn');
                    editButton.onclick = () => editInvoice(invoice);
                    actionsCell.appendChild(editButton);
                }

                if (currentUserPermissions.role === 'admin') {
                    const deleteButton = document.createElement('button');
                    deleteButton.textContent = 'Delete';
                    deleteButton.classList.add('delete-btn');
                    deleteButton.onclick = () => showConfirmation(`Are you sure you want to delete Invoice No. ${invoice.invoiceNo}?`, () => {
                        invoices.splice(index, 1);
                        saveInvoices();
                        drawInvoices();
                        showMessage(`Invoice ${invoice.invoiceNo} deleted.`);
                        updateDashboard();
                        updateCharts();
                    });
                    actionsCell.appendChild(deleteButton);
                }
            });
        }

        // Function to convert a number to words (USD)
        function numberToWords(num) {
            const units = ['', 'one', 'two', 'three', 'four', 'five', 'six', 'seven', 'eight', 'nine'];
            const teens = ['ten', 'eleven', 'twelve', 'thirteen', 'fourteen', 'fifteen', 'sixteen', 'seventeen', 'eighteen', 'nineteen'];
            const tens = ['', '', 'twenty', 'thirty', 'forty', 'fifty', 'sixty', 'seventy', 'eighty', 'ninety'];
            const scales = ['', 'thousand', 'million', 'billion', 'trillion'];

            function convertLessThanOneThousand(n) {
                let s = '';
                if (Math.floor(n / 100) > 0) {
                    s += units[Math.floor(n / 100)] + ' hundred ';
                    n %= 100;
                }
                if (n >= 10 && n <= 19) {
                    s += teens[n - 10];
                } else if (n >= 20 || n < 10) {
                    s += tens[Math.floor(n / 10)] + ' ';
                    s += units[n % 10];
                }
                return s.trim();
            }

            if (num === 0) return 'zero';

            let result = '';
            let numStr = num.toFixed(2);
            let [integerPart, decimalPart] = numStr.split('.');
            let integerNum = parseInt(integerPart, 10);
            let decimalNum = parseInt(decimalPart, 10);

            if (integerNum === 0) {
                result = 'zero';
            } else {
                let i = 0;
                while (integerNum > 0) {
                    const chunk = integerNum % 1000;
                    if (chunk !== 0) {
                        result = convertLessThanOneThousand(chunk) + ' ' + scales[i] + ' ' + result;
                    }
                    integerNum = Math.floor(integerNum / 1000);
                    i++;
                }
            }

            result = result.trim() + ' US DOLLARS';

            if (decimalNum > 0) {
                result += ' AND ' + convertLessThanOneThousand(decimalNum) + ' CENTS';
            }

            return result.toUpperCase();
        }


        // Function to generate printable invoice HTML (for window.print)
        function generateInvoicePrintHTML(invoice) {
            const printWindow = window.open('', '_blank');
            if (!printWindow) {
                showMessage('Pop-up blocked! Please allow pop-ups for this site to generate the document.', 'error');
                return;
            }

            const amountInWords = numberToWords(invoice.grandTotal);

            printWindow.document.write(`
                <html>
                <head>
                    <title>Invoice No. ${invoice.invoiceNo}</title>
                    <style>
                        body { font-family: 'Arial', sans-serif; margin: 0; padding: 0; color: #333; font-size: 9pt; } /* Reduced base font size */
                        .document-print-container { width: 210mm; min-height: 297mm; margin: 0 auto; padding: 8mm 12mm; box-sizing: border-box; color: #000; font-size: 9pt; }
                        .header { text-align: center; margin-bottom: 6mm; }
                        .header p:first-child { color: #003366; font-size: 1.1em; font-weight: bold; margin-bottom: 1.5mm; }
                        .header p { color: #333; font-size: 0.8em; margin: 0.4mm 0; }
                        .header h1 { color: #003366; font-size: 1.6em; margin: 4mm 0 3mm 0; text-transform: uppercase; border-bottom: 2px solid #003366; padding-bottom: 2.5mm; }
                        .header strong { font-size: 1em; }
                        .details-table { width: 100%; border-collapse: collapse; margin-bottom: 5mm; border: 1px solid #999; font-size: 0.85em;}
                        .details-table td { padding: 3mm; border: 1px solid #ddd; vertical-align: top; background-color: #f8f8f8;}
                        .details-table .label { font-weight: bold; width: 120px; background-color: #e6f3fa; color: #003366;}
                        .item-table { width: 100%; border-collapse: collapse; margin-top: 5mm; font-size: 0.85em; }
                        .item-table th, .item-table td { border: 1px solid #999; padding: 3mm; text-align: left; }
                        .item-table th { background-color: #0056b3; color: white; font-weight: bold; }
                        .item-table tbody tr:nth-child(even) { background-color: #f0f0f0; }
                        .item-table tbody tr:nth-child(odd) { background-color: #ffffff; }
                        .item-table td:nth-child(1) { width: 25%; font-weight: bold; } /* Marks & Numbers / Chassis Number */
                        .item-table td:nth-child(2) { width: 40%; font-weight: bold; } /* Description of Goods */
                        .total-row { font-weight: bold; background-color: #cfe8ff; color: #000; }
                        .footer { margin-top: 10mm; text-align: center; font-size: 0.75em; color: #555; }
                        @page { size: A4; margin: 0; }
                    </style>
                </head>
                <body>
                    <div class="document-print-container">
                        <div class="header">
                            <p>HOJAFA AUTO LTD FZE</p>
                            <p>Tel:+25377828674/+251912617438 Email; hojafaautoltdfze@gmail.com</p>
                            <p>UKAB FREE ZONE (FZE) REPUBLIC OF DJIBOUTI</p>
                            <h1>COMMERCIAL INVOICE</h1>
                            <p><strong>INVOICE NO:</strong> ${invoice.invoiceNo}</p>
                            <p><strong>DATE:</strong> ${invoice.createdDate || new Date(invoice.timestamp).toLocaleDateString()}</p>
                        </div>

                        <table class="details-table">
                            <tr>
                                <td class="label">LC NUMBER:</td>
                                <td>${invoice.lcNumber || ''}</td>
                                <td class="label">TIN NUMBER:</td>
                                <td>${invoice.tinNumber || ''}</td>
                            </tr>
                            <tr>
                                <td class="label">PROFORMA NUMBER:</td>
                                <td>${invoice.proformaNumber || ''}</td>
                                <td class="label">DATE OF PROFORMA:</td>
                                <td>${invoice.proformaDate || ''}</td>
                            </tr>
                            <tr>
                                <td class="label">NOTIFY:</td>
                                <td>${invoice.notify || ''}</td>
                                <td class="label">CONSIGNEE:</td>
                                <td>${invoice.consignee || ''}</td>
                            </tr>
                        </table>

                        <table class="item-table">
                            <thead>
                                <tr>
                                    <th>Marks & Numbers</th>
                                    <th>Description of Goods</th>
                                    <th>QTY (unit)</th>
                                    <th>VOLUME (CBM)</th>
                                    <th>Unit Price (USD) FCA DJIBOUTI PORT</th>
                                    <th>Total Price (USD) FCA DJIBOUTI</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${invoice.items.map(item => `
                                    <tr>
                                        <td>${item.chassisNumber}</td>
                                        <td>${item.description}</td>
                                        <td>${item.qty}</td>
                                        <td>${item.volume || ''}</td>
                                        <td>${item.unitPrice.toFixed(2)}</td>
                                        <td>${item.totalPrice.toFixed(2)}</td>
                                    </tr>
                                `).join('')}
                                <tr class="total-row">
                                    <td colspan="5" style="text-align: right;">TOTAL AMOUNT IN WORD: ${amountInWords}</td>
                                    <td>$${invoice.grandTotal.toFixed(2)}</td>
                                </tr>
                            </tbody>
                        </table>

                        <table class="details-table" style="margin-top: 10mm;">
                            <tr>
                                <td class="label">Port of Loading/Airport of Dep:</td>
                                <td>${invoice.portLoading || ''}</td>
                            </tr>
                            <tr>
                                <td class="label">Port of Discharge/Airport of Dest:</td>
                                <td>${invoice.portDischarge || ''}</td>
                            </tr>
                            <tr>
                                <td class="label">SHIPMENT:</td>
                                <td>${invoice.shipment || ''}</td>
                            </tr>
                            <tr>
                                <td class="label">TERMS OF PAYMENT:</td>
                                <td>${invoice.termsPayment || ''}</td>
                            </tr>
                             <tr>
                                <td class="label">BENEFICIARY:</td>
                                <td>HOJAFA AUTO LTD FZE</td>
                            </tr>
                            <tr>
                                <td class="label">BANK:</td>
                                <td>${invoice.bank || ''}</td>
                            </tr>
                            <tr>
                                <td class="label">ACCOUNT NUMBER:</td>
                                <td>${invoice.accountNo || ''}</td>
                            </tr>
                            <tr>
                                <td class="label">SWIFT:</td>
                                <td>${invoice.swift || ''}</td>
                            </tr>
                        </table>

                        <div class="footer">
                            <p>ISSUED BY: HOJAFA AUTO LTD FZE</p>
                            <p>Date: ${invoice.createdDate || new Date(invoice.timestamp).toLocaleDateString()}</p>
                        </div>
                    </div>
                </body>
                </html>
            `);
            printWindow.document.close();
            printWindow.print();
        }
        if (generateInvoicePrintButton) {
            generateInvoicePrintButton.addEventListener('click', () => {
                generateInvoicePrintHTML(invoices[0]);
            });
        }

        // Initial setup for invoice item row
        addInvoiceItemRow();

        // --- NEW: Export/Import for Commercial Invoice ---
        document.getElementById('exportInvoiceToExcel')?.addEventListener('click', () => {
            const invoiceNo = document.getElementById('invoiceNo').value;
            const createdDate = document.getElementById('invoiceCreatedDate').value; // Export createdDate
            const lcNumber = document.getElementById('invoiceLcNumber').value;
            const tinNumber = document.getElementById('invoiceTinNumber').value;
            const proformaNumber = document.getElementById('invoiceProformaNumber').value;
            const proformaDate = document.getElementById('invoiceProformaDate').value;
            const notify = document.getElementById('invoiceNotify').value;
            const consignee = document.getElementById('invoiceConsignee').value;
            const portLoading = document.getElementById('invoicePortLoading').value;
            const portDischarge = document.getElementById('invoicePortDischarge').value;
            const shipment = document.getElementById('invoiceShipment').value;
            const termsPayment = document.getElementById('invoiceTermsPayment').value;
            const bank = document.getElementById('invoiceBank').value;
            const accountNo = document.getElementById('invoiceAccountNo').value;
            const swift = document.getElementById('invoiceSwift').value;
            const grandTotal = document.getElementById('invoiceGrandTotal').value;

            const invoiceItems = [];
            document.querySelectorAll('.invoice-item-row').forEach(row => {
                const chassisNumber = row.querySelector('.item-chassis-number')?.value || '';
                const description = row.querySelector('.item-description')?.value || '';
                const qty = row.querySelector('.item-qty')?.value || '';
                const volume = row.querySelector('.item-volume')?.value || '';
                const unitPrice = row.querySelector('.item-unit-price')?.value || '';
                const totalPrice = row.querySelector('.item-total-price')?.value || '';
                invoiceItems.push([chassisNumber, description, qty, volume, unitPrice, totalPrice]);
            });

            const headerDetails = [
                ["Invoice No", invoiceNo],
                ["Created Documents Date", createdDate], // Export createdDate
                ["LC Number", lcNumber],
                ["TIN Number", tinNumber],
                ["Proforma Number", proformaNumber],
                ["Date of Proforma", proformaDate],
                ["Notify", notify],
                ["Consignee", consignee],
                ["Port of Loading/Airport of Dep", portLoading],
                ["Port of Discharge/Airport of Dest", portDischarge],
                ["Shipment Type", shipment],
                ["Terms of Payment", termsPayment],
                ["Bank", bank],
                ["Account Number", accountNo],
                ["SWIFT", swift],
                ["Grand Total (USD)", grandTotal]
            ];

            const itemHeaders = ["Chassis Number", "Description", "Quantity", "Volume (CBM)", "Unit Price (USD)", "Total Price (USD)"];

            const ws_data = [
                ["Commercial Invoice Details"],
                [], // Spacer
                ...headerDetails,
                [], // Spacer
                ["Invoice Items"],
                itemHeaders,
                ...invoiceItems
            ];

            const wb = XLSX.utils.book_new();
            const ws = XLSX.utils.aoa_to_sheet(ws_data);
            XLSX.utils.book_append_sheet(wb, ws, "Commercial Invoice");

            XLSX.writeFile(wb, `Commercial_Invoice_${invoiceNo || 'No'}.xlsx`);
            showMessage('Invoice data exported to Excel!', 'success');
        });

        document.getElementById('importInvoiceExcel')?.addEventListener('change', (event) => {
            const file = event.target.files[0];
            if (!file) {
                return;
            }

            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    const sheetName = workbook.SheetNames[0];
                    const worksheet = workbook.Sheets[sheetName];
                    const json = XLSX.utils.sheet_to_json(worksheet, { header: 1 });

                    if (json.length < 7) { // Minimum rows for header + 1 item
                        showMessage('Invalid Excel file for Invoice. Expected at least header and one item row.', 'error');
                        event.target.value = null;
                        return;
                    }

                    // Reset form first
                    resetInvoiceForm(); // This will also generate a new invoice number

                    // Populate header details (assuming fixed positions based on export structure)
                    // Adjust indices if your export structure changes
                    const headerMap = new Map(json.slice(2, 18)); // Rows 2 to 17 contain header key-value pairs (adjusted for new date field)

                    invoiceCreatedDateInput.value = headerMap.get("Created Documents Date") || ''; // Import createdDate
                    invoiceLcNumberInput.value = headerMap.get("LC Number") || '';
                    invoiceTinNumberInput.value = headerMap.get("TIN Number") || '';
                    invoiceProformaNumberInput.value = headerMap.get("Proforma Number") || '';
                    invoiceProformaDateInput.value = headerMap.get("Date of Proforma") || '';
                    invoiceNotify.value = headerMap.get("Notify") || '';
                    invoiceConsignee.value = headerMap.get("Consignee") || '';
                    invoicePortLoadingInput.value = headerMap.get("Port of Loading/Airport of Dep") || 'DJIBOUTI FREE ZONE';
                    invoicePortDischargeInput.value = headerMap.get("Port of Discharge/Airport of Dest") || 'ADDIS ABABA, ETHIOPIA';
                    invoiceShipment.value = headerMap.get("Shipment Type") || 'SELF DRIVE';
                    invoiceTermsPayment.value = headerMap.get("Terms of Payment") || 'LC';
                    invoiceBank.value = headerMap.get("Bank") || 'CAC INTERNATIONAL BANK';
                    invoiceAccountNo.value = headerMap.get("Account Number") || '1003471115';
                    invoiceSwift.value = headerMap.get("SWIFT") || 'CACDDJJD';

                    // Clear existing invoice items before adding imported ones
                    invoiceItemsContainer.innerHTML = '';

                    // Populate invoice items (starting after "Invoice Items" label and item headers)
                    const itemStartIndex = json.findIndex(row => row[0] === "Invoice Items") + 2;
                    if (itemStartIndex > 0) {
                        for (let i = itemStartIndex; i < json.length; i++) {
                            const itemData = json[i];
                            if (itemData.length >= 6) {
                                addInvoiceItemRow({
                                    chassisNumber: itemData[0],
                                    description: itemData[1],
                                    qty: parseFloat(itemData[2]),
                                    volume: parseFloat(itemData[3]),
                                    unitPrice: parseFloat(itemData[4]),
                                    totalPrice: parseFloat(itemData[5])
                                });
                            }
                        }
                    }

                    calculateGrandTotal(); // Recalculate total after import
                    showMessage('Invoice data imported successfully!', 'success');
                } catch (e) {
                    showMessage('Error importing Invoice Excel file. Please ensure it matches the expected format.', 'error');
                    console.error('Error importing Invoice Excel:', e);
                } finally {
                    event.target.value = null; // Clear the file input
                }
            };
            reader.readAsArrayBuffer(file);
        });


        // --- Packing List Functions ---

        // Function to add a new item row to the packing list form
        function addPackingListItemRow(item = {}) {
            const itemDiv = document.createElement('div');
            itemDiv.classList.add('packing-list-item-row');
            itemDiv.innerHTML = `
                <input type="text" class="pl-item-chassis-number" placeholder="Chassis No./Engine No." value="${item.chassisNumber || ''}" required>
                <input type="text" class="pl-item-description" placeholder="Description" value="${item.description || 'DUMP TRUCK'}" required>
                <input type="number" class="pl-item-qty" placeholder="Qty" value="${item.qty || 1}" min="1" required>
                <input type="number" class="pl-item-volume" placeholder="Volume (CBM)" step="0.01" value="${item.volume || ''}">
                <input type="number" class="pl-item-net-weight" placeholder="Net Weight (KGS)" step="0.01" value="${item.netWeight || ''}">
                <input type="number" class="pl-item-gross-weight" placeholder="Gross Weight (KGS)" step="0.01" value="${item.grossWeight || ''}">
                <input type="number" class="pl-item-manufacture-year" placeholder="Manufacture Year" min="1900" max="${new Date().getFullYear()}" value="${item.manufactureYear || ''}">
                <button type="button" class="delete-btn remove-pl-item-btn">-</button>
            `;
            packingListItemsContainer.appendChild(itemDiv);

            const removeButton = itemDiv.querySelector('.remove-pl-item-btn');
            removeButton.addEventListener('click', () => {
                itemDiv.remove();
            });
        }

        // Resets the packing list form to its initial state for new entry
        function resetPackingListForm() {
            packingListForm.reset();
            packingListItemsContainer.innerHTML = '';
            addPackingListItemRow();
            packingListNoInput.value = generateSequentialId('HJF-PL-', packingLists.map(pl => pl.packingListNo));
            packingListCreatedDateInput.valueAsDate = new Date(); // Set to current date
            packingListGoodsCountryOriginInput.value = 'CHINA';
            submitPackingListBtn.textContent = 'Create Packing List';
            cancelPackingListEditBtn.style.display = 'none';
            generatePackingListPrintButton.style.display = 'none';
            currentEditingPackingList = null;
        }

        // Function to populate packing list form for editing
        function editPackingList(packingList) {
            if (currentUserPermissions.role !== 'admin' && !currentUserPermissions.canEditPackingLists) {
                showMessage('You do not have permission to edit packing lists.', 'error');
                return;
            }
            currentEditingPackingList = packingList;
            showView('packing-list-view');

            packingListNoInput.value = packingList.packingListNo;
            packingListCreatedDateInput.value = packingList.createdDate || ''; // Populate createdDate
            packingListInvoiceNoInput.value = packingList.invoiceNo || '';
            packingListLcNumberInput.value = packingList.lcNumber || '';
            packingListTinNumberInput.value = packingList.tinNumber || '';
            packingListProformaNumberInput.value = packingList.proformaNumber || '';
            packingListProformaDateInput.value = packingList.proformaDate || '';
            packingListNotifyInput.value = packingList.notify || '';
            packingListConsignee.value = packingList.consignee || '';
            packingListMarksNumbers.value = packingList.marksNumbers || '';
            packingListGoodsCountryOriginInput.value = packingList.goodsCountryOrigin || 'CHINA';

            packingListItemsContainer.innerHTML = '';
            packingList.items.forEach(item => addPackingListItemRow(item));

            submitPackingListBtn.textContent = 'Update Packing List';
            cancelPackingListEditBtn.style.display = 'inline-block';
            generatePackingListPrintButton.style.display = 'inline-block';
            generatePackingListPrintButton.onclick = () => generatePackingListPrintHTML(packingList);
        }

        // Event listener for adding packing list item
        if (addPackingListItemButton) {
            addPackingListItemButton.addEventListener('click', () => addPackingListItemRow());
        }

        // Event listener for packing list form submission
        if (packingListForm) {
            packingListForm.addEventListener('submit', (event) => {
                event.preventDefault();

                const packingListNo = packingListNoInput.value.trim();
                const createdDate = packingListCreatedDateInput.value; // Get createdDate
                const invoiceNo = packingListInvoiceNoInput.value.trim();
                const lcNumber = packingListLcNumberInput.value.trim();
                const tinNumber = packingListTinNumberInput.value.trim();
                const proformaNumber = packingListProformaNumberInput.value.trim();
                const proformaDate = packingListProformaDateInput.value.trim();
                const notify = packingListNotifyInput.value.trim();
                const consignee = packingListConsignee.value.trim();
                const marksNumbers = packingListMarksNumbers.value.trim();
                const goodsCountryOrigin = packingListGoodsCountryOriginInput.value.trim();

                const items = [];
                let hasEmptyItemField = false;
                document.querySelectorAll('.packing-list-item-row').forEach(row => {
                    const chassisNumber = row.querySelector('.pl-item-chassis-number').value.trim();
                    const description = row.querySelector('.pl-item-description').value.trim();
                    const qty = parseFloat(row.querySelector('.pl-item-qty').value);
                    const volume = parseFloat(row.querySelector('.pl-item-volume').value) || 0;
                    const netWeight = parseFloat(row.querySelector('.pl-item-net-weight').value) || 0;
                    const grossWeight = parseFloat(row.querySelector('.pl-item-gross-weight').value) || 0;
                    const manufactureYear = row.querySelector('.pl-item-manufacture-year').value.trim();


                    if (!chassisNumber || !description || isNaN(qty)) {
                        hasEmptyItemField = true;
                        return;
                    }
                    items.push({ chassisNumber, description, qty, volume, netWeight, grossWeight, manufactureYear });
                });

                if (hasEmptyItemField) {
                    showMessage('Please fill in all required fields for packing list items.', 'error');
                    return;
                }

                if (items.length === 0) {
                     showMessage('Please add at least one item to the packing list.', 'error');
                     return;
                }

                const newPackingListData = {
                    packingListNo,
                    createdDate, // Store createdDate
                    invoiceNo: invoiceNo,
                    lcNumber,
                    tinNumber,
                    proformaNumber,
                    proformaDate,
                    notify,
                    consignee,
                    marksNumbers,
                    goodsCountryOrigin,
                    items,
                    timestamp: currentEditingPackingList ? currentEditingPackingList.timestamp : new Date()
                };

                if (currentEditingPackingList) {
                    const index = packingLists.findIndex(pl => pl.packingListNo === currentEditingPackingList.packingListNo);
                    if (index !== -1) {
                        packingLists[index] = newPackingListData;
                        showMessage(`Packing List ${packingListNo} updated successfully.`);
                    } else {
                        packingLists.unshift(newPackingListData);
                        showMessage(`Packing List ${packingListNo} created successfully (as update failed to find original).`);
                    }
                    currentEditingPackingList = null;
                } else {
                    if (packingLists.some(pl => pl.packingListNo === packingListNo)) {
                        showMessage(`Packing List No. ${packingListNo} already exists.`, 'error');
                        return;
                    }
                    packingLists.unshift(newPackingListData);
                    showMessage(`Packing List ${packingListNo} created successfully.`);
                }

                savePackingLists();
                resetPackingListForm();
                drawPackingLists();
                updateDashboard();
                updateCharts();
                generatePackingListPrintButton.style.display = 'inline-block';
                generatePackingListPrintButton.onclick = () => generatePackingListPrintHTML(newPackingListData);
            });
        }

        // Event listener for Packing List Cancel Edit button
        if (cancelPackingListEditBtn) {
            cancelPackingListEditBtn.addEventListener('click', resetPackingListForm);
        }

        // Function to draw packing lists table
        function drawPackingLists() {
            if (!packingListsTableBody) return;
            packingListsTableBody.innerHTML = '';

            packingLists.sort((a, b) => b.timestamp - a.timestamp);

            packingLists.forEach((pl, index) => {
                const row = packingListsTableBody.insertRow();
                row.insertCell(0).textContent = pl.packingListNo;
                row.insertCell(1).textContent = pl.invoiceNo || 'N/A';
                row.insertCell(2).textContent = pl.consignee || 'N/A';
                row.insertCell(3).textContent = pl.createdDate || pl.timestamp.toLocaleDateString(); // Display createdDate
                const actionsCell = row.insertCell(4);

                const viewButton = document.createElement('button');
                viewButton.textContent = 'View/Print';
                viewButton.classList.add('generate-doc-btn');
                viewButton.onclick = () => generatePackingListPrintHTML(pl);
                actionsCell.appendChild(viewButton);

                if (currentUserPermissions.role === 'admin' || currentUserPermissions.canEditPackingLists) { // Allow edit if admin or has specific permission
                    const editButton = document.createElement('button');
                    editButton.textContent = 'Edit';
                    editButton.classList.add('edit-btn');
                    editButton.onclick = () => editPackingList(pl);
                    actionsCell.appendChild(editButton);
                }

                if (currentUserPermissions.role === 'admin') {
                    const deleteButton = document.createElement('button');
                    deleteButton.textContent = 'Delete';
                    deleteButton.classList.add('delete-btn');
                    deleteButton.onclick = () => showConfirmation(`Are you sure you want to delete Packing List No. ${pl.packingListNo}?`, () => {
                        packingLists.splice(index, 1);
                        savePackingLists();
                        drawPackingLists();
                        showMessage(`Packing List ${pl.packingListNo} deleted.`);
                        updateDashboard();
                        updateCharts();
                    });
                    actionsCell.appendChild(deleteButton);
                }
            });
        }

        // Function to generate printable packing list HTML (for window.print)
        function generatePackingListPrintHTML(packingList) {
            const printWindow = window.open('', '_blank');
            if (!printWindow) {
                showMessage('Pop-up blocked! Please allow pop-ups for this site to generate the document.', 'error');
                return;
            }
            printWindow.document.write(`
                <html>
                <head>
                    <title>Packing List No. ${packingList.packingListNo}</title>
                    <style>
                        body { font-family: 'Arial', sans-serif; margin: 0; padding: 0; color: #333; font-size: 9pt; }
                        .document-print-container { width: 210mm; min-height: 297mm; margin: 0 auto; padding: 8mm 12mm; box-sizing: border-box; color: #000; font-size: 9pt; }
                        .header { text-align: center; margin-bottom: 6mm; }
                        .header p:first-child { color: #003366; font-size: 1.1em; font-weight: bold; margin-bottom: 1.5mm; }
                        .header p { color: #333; font-size: 0.8em; margin: 0.4mm 0; }
                        .header h1 { color: #003366; font-size: 1.6em; margin: 4mm 0 3mm 0; text-transform: uppercase; border-bottom: 2px solid #003366; padding-bottom: 2.5mm; }
                        .header strong { font-size: 1em; }
                        .details-table { width: 100%; border-collapse: collapse; margin-bottom: 5mm; border: 1px solid #999; font-size: 0.85em;}
                        .details-table td { padding: 3mm; border: 1px solid #ddd; vertical-align: top; background-color: #f8f8f8;}
                        .details-table .label { font-weight: bold; width: 120px; background-color: #e6f3fa; color: #003366;}
                        .item-table { width: 100%; border-collapse: collapse; margin-top: 5mm; font-size: 0.85em; }
                        .item-table th, .item-table td { border: 1px solid #999; padding: 3mm; text-align: left; }
                        .item-table th { background-color: #0056b3; color: white; font-weight: bold; }
                        .item-table tbody tr:nth-child(even) { background-color: #f0f0f0; }
                        .item-table tbody tr:nth-child(odd) { background-color: #ffffff; }
                        .item-table td:nth-child(1) { width: 25%; font-weight: bold; } /* Chassis Number */
                        .item-table td:nth-child(2) { width: 40%; font-weight: bold; } /* Description of Goods */
                        .footer { margin-top: 10mm; text-align: center; font-size: 0.75em; color: #555; }
                        @page { size: A4; margin: 0; }
                    </style>
                </head>
                <body>
                    <div class="document-print-container">
                        <div class="header">
                            <p>HOJAFA AUTO LTD FZE</p>
                            <p>Tel:+25377828674/+251912617438 Email; hojafaautoltdfze@gmail.com</p>
                            <p>UKAB FREE ZONE (FZE) REPUBLIC OF DJIBOUTI</p>
                            <h1>PACKING LIST</h1>
                            <p><strong>PACKING LIST NO:</strong> ${packingList.packingListNo}</p>
                            <p><strong>DATE:</strong> ${packingList.createdDate || new Date(packingList.timestamp).toLocaleDateString()}</p>
                            <p><strong>ASSOCIATED INVOICE NO:</strong> ${packingList.invoiceNo || 'N/A'}</p>
                        </div>

                        <table class="details-table">
                            <tr>
                                <td class="label">LC NUMBER:</td>
                                <td>${packingList.lcNumber || ''}</td>
                                <td class="label">TIN NUMBER:</td>
                                <td>${packingList.tinNumber || ''}</td>
                            </tr>
                            <tr>
                                <td class="label">PROFORMA NUMBER:</td>
                                <td>${packingList.proformaNumber || ''}</td>
                                <td class="label">DATE OF PROFORMA:</td>
                                <td>${packingList.proformaDate || ''}</td>
                            </tr>
                            <tr>
                                <td class="label">NOTIFY PARTY:</td>
                                <td>${packingList.notify || ''}</td>
                                <td class="label">CONSIGNEE:</td>
                                <td>${packingList.consignee || ''}</td>
                            </tr>
                            <tr>
                                <td class="label">MARKS & NUMBERS:</td>
                                <td colspan="3">${packingList.marksNumbers || ''}</td>
                            </tr>
                            <tr>
                                <td class="label">GOODS COUNTRY OF ORIGIN:</td>
                                <td colspan="3">${packingList.goodsCountryOrigin || ''}</td>
                            </tr>
                        </table>

                        <table class="item-table">
                            <thead>
                                <tr>
                                    <th>Chassis Number/Engine Number</th>
                                    <th>Description of Goods</th>
                                    <th>QTY (unit)</th>
                                    <th>VOLUME (CBM)</th>
                                    <th>NET WEIGHT (KGS)</th>
                                    <th>GROSS WEIGHT (KGS)</th>
                                    <th>Manufacture Year</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${packingList.items.map(item => `
                                    <tr>
                                        <td>${item.chassisNumber}</td>
                                        <td>${item.description}</td>
                                        <td>${item.qty}</td>
                                        <td>${item.volume || ''}</td>
                                        <td>${item.netWeight.toFixed(2)}</td>
                                        <td>${item.grossWeight.toFixed(2)}</td>
                                        <td>${item.manufactureYear || ''}</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>

                        <div class="footer">
                            <p>ISSUED BY: HOJAFA AUTO LTD FZE</p>
                            <p>Date: ${packingList.createdDate || new Date(packingList.timestamp).toLocaleDateString()}</p>
                        </div>
                    </div>
                </body>
                </html>
            `);
            printWindow.document.close();
            printWindow.print();
        }
        if (generatePackingListPrintButton) {
            generatePackingListPrintButton.addEventListener('click', () => {
                generatePackingListPrintHTML(packingLists[0]);
            });
        }
        // Initial setup for packing list item row
        addPackingListItemRow();

        // --- NEW: Export/Import for Packing List ---
        document.getElementById('exportPackingListToExcel')?.addEventListener('click', () => {
            const packingListNo = document.getElementById('packingListNo').value;
            const createdDate = document.getElementById('packingListCreatedDate').value; // Export createdDate
            const invoiceNo = document.getElementById('packingListInvoiceNo').value;
            const lcNumber = document.getElementById('packingListLcNumber').value;
            const tinNumber = document.getElementById('packingListTinNumber').value;
            const proformaNumber = document.getElementById('packingListProformaNumber').value;
            const proformaDate = document.getElementById('packingListProformaDate').value;
            const notify = document.getElementById('packingListNotify').value;
            const consignee = document.getElementById('packingListConsignee').value;
            const marksNumbers = document.getElementById('packingListMarksNumbers').value;
            const goodsCountryOrigin = document.getElementById('packingListGoodsCountryOrigin').value;

            const packingListItems = [];
            document.querySelectorAll('.packing-list-item-row').forEach(row => {
                const chassisNumber = row.querySelector('.pl-item-chassis-number')?.value || '';
                const description = row.querySelector('.pl-item-description')?.value || '';
                const qty = row.querySelector('.pl-item-qty')?.value || '';
                const volume = row.querySelector('.pl-item-volume')?.value || '';
                const netWeight = row.querySelector('.pl-item-net-weight')?.value || '';
                const grossWeight = row.querySelector('.pl-item-gross-weight')?.value || '';
                const manufactureYear = row.querySelector('.pl-item-manufacture-year')?.value || '';
                packingListItems.push([chassisNumber, description, qty, volume, netWeight, grossWeight, manufactureYear]);
            });

            const headerDetails = [
                ["Packing List No", packingListNo],
                ["Created Documents Date", createdDate], // Export createdDate
                ["Associated Invoice No", invoiceNo],
                ["LC Number", lcNumber],
                ["TIN Number", tinNumber],
                ["Proforma Number", proformaNumber],
                ["Date of Proforma", proformaDate],
                ["Notify Party", notify],
                ["Consignee", consignee],
                ["Marks & Numbers", marksNumbers],
                ["Goods Country of Origin", goodsCountryOrigin]
            ];

            const itemHeaders = ["Chassis Number/Engine Number", "Description", "Quantity", "Volume (CBM)", "Net Weight (KGS)", "Gross Weight (KGS)", "Manufacture Year"];

            const ws_data = [
                ["Packing List Details"],
                [], // Spacer
                ...headerDetails,
                [], // Spacer
                ["Packing List Items"],
                itemHeaders,
                ...packingListItems
            ];

            const wb = XLSX.utils.book_new();
            const ws = XLSX.utils.aoa_to_sheet(ws_data);
            XLSX.utils.book_append_sheet(wb, ws, "Packing List");

            XLSX.writeFile(wb, `Packing_List_${packingListNo || 'No'}.xlsx`);
            showMessage('Packing List data exported to Excel!', 'success');
        });

        document.getElementById('importPackingListExcel')?.addEventListener('change', (event) => {
            const file = event.target.files[0];
            if (!file) {
                return;
            }

            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    const sheetName = workbook.SheetNames[0];
                    const worksheet = workbook.Sheets[sheetName];
                    const json = XLSX.utils.sheet_to_json(worksheet, { header: 1 });

                    if (json.length < 13) { // Minimum rows for header + 1 item
                        showMessage('Invalid Excel file for Packing List. Expected at least header and one item row.', 'error');
                        event.target.value = null;
                        return;
                    }

                    resetPackingListForm(); // This will also generate a new PL number

                    const headerMap = new Map(json.slice(2, 13)); // Rows 2 to 12 contain header key-value pairs (adjusted for new date field)

                    packingListCreatedDateInput.value = headerMap.get("Created Documents Date") || ''; // Import createdDate
                    packingListInvoiceNoInput.value = headerMap.get("Associated Invoice No") || '';
                    packingListLcNumberInput.value = headerMap.get("LC Number") || '';
                    packingListTinNumberInput.value = headerMap.get("TIN Number") || '';
                    packingListProformaNumberInput.value = headerMap.get("Proforma Number") || '';
                    packingListProformaDateInput.value = headerMap.get("Date of Proforma") || '';
                    packingListNotifyInput.value = headerMap.get("Notify Party") || '';
                    packingListConsignee.value = headerMap.get("Consignee") || '';
                    packingListMarksNumbers.value = headerMap.get("Marks & Numbers") || '';
                    packingListGoodsCountryOriginInput.value = headerMap.get("Goods Country of Origin") || 'CHINA';

                    packingListItemsContainer.innerHTML = '';

                    const itemStartIndex = json.findIndex(row => row[0] === "Packing List Items") + 2;
                    if (itemStartIndex > 0) {
                        for (let i = itemStartIndex; i < json.length; i++) {
                            const itemData = json[i];
                            if (itemData.length >= 7) {
                                addPackingListItemRow({
                                    chassisNumber: itemData[0],
                                    description: itemData[1],
                                    qty: parseFloat(itemData[2]),
                                    volume: parseFloat(itemData[3]),
                                    netWeight: parseFloat(itemData[4]),
                                    grossWeight: parseFloat(itemData[5]),
                                    manufactureYear: itemData[6]
                                });
                            }
                        }
                    }
                    showMessage('Packing List data imported successfully!', 'success');
                } catch (e) {
                    showMessage('Error importing Packing List Excel file. Please ensure it matches the expected format.', 'error');
                    console.error('Error importing Packing List Excel:', e);
                } finally {
                    event.target.value = null;
                }
            };
            reader.readAsArrayBuffer(file);
        });


        // --- Truck Waybill Functions ---

        // Function to add a new item row to the waybill form
        function addWaybillItemRow(item = {}) {
            const itemDiv = document.createElement('div');
            itemDiv.classList.add('waybill-item-row');
            itemDiv.innerHTML = `
                <input type="text" class="wb-item-description" placeholder="Description of Goods" value="${item.description || 'DUMP TRUCK'}" required>
                <input type="number" class="wb-item-qty" placeholder="Qty (Units)" value="${item.qty || 1}" min="1" required>
                <input type="text" class="wb-item-chassis-engine" placeholder="Chassis No./Engine No." value="${item.chassisEngineNo || ''}" required>
                <input type="number" class="wb-item-gross-weight" placeholder="Total Gross Weight (KGS)" step="0.01" value="${item.grossWeight || ''}">
                <input type="number" class="wb-item-measurement" placeholder="Total Measurement (CBM)" step="0.01" value="${item.measurement || ''}">
                <input type="number" class="wb-item-manufacture-year" placeholder="Manufacture Year" min="1900" max="${new Date().getFullYear()}" value="${item.manufactureYear || ''}">
                <button type="button" class="delete-btn remove-wb-item-btn">-</button>
            `;
            waybillItemsContainer.appendChild(itemDiv);

            const removeButton = itemDiv.querySelector('.remove-wb-item-btn');
            removeButton.addEventListener('click', () => {
                itemDiv.remove();
                calculateWaybillOverallTotals();
            });

            itemDiv.querySelectorAll('input[type="number"]').forEach(input => {
                input.addEventListener('input', calculateWaybillOverallTotals);
            });
        }

        // Function to calculate overall gross weight and measurement for waybill
        function calculateWaybillOverallTotals() {
            let totalGrossWeight = 0;
            let totalMeasurement = 0;

            document.querySelectorAll('.waybill-item-row').forEach(row => {
                const grossWeight = parseFloat(row.querySelector('.wb-item-gross-weight').value) || 0;
                const measurement = parseFloat(row.querySelector('.wb-item-measurement').value) || 0;
                totalGrossWeight += grossWeight;
                totalMeasurement += measurement;
            });

            waybillOverallGrossWeightInput.value = totalGrossWeight.toFixed(2);
            waybillOverallMeasurementInput.value = totalMeasurement.toFixed(2);
        }

        // Resets the waybill form to its initial state for new entry
        function resetWaybillForm() {
            truckWaybillForm.reset();
            waybillItemsContainer.innerHTML = '';
            addWaybillItemRow();
            waybillNoInput.value = generateSequentialId('HJF-WB-', waybills.map(wb => wb.waybillNo));
            waybillCreatedDateInput.valueAsDate = new Date(); // Set to current date
            calculateWaybillOverallTotals();
            document.getElementById('waybillShipper').value = 'HOJAFA AUTO LTD FZE';
            document.getElementById('waybillPortLoading').value = 'DJIBOUTI FREE ZONE';
            document.getElementById('waybillPortDischarge').value = 'ADDIS ABABA, ETHIOPIA';
            waybillFreightPayableInput.value = 'DESTINATION';
            waybillGoodsCountryOriginInput.value = 'CHINA';

            submitWaybillBtn.textContent = 'Create Waybill';
            cancelWaybillEditBtn.style.display = 'none';
            generateWaybillPrintButton.style.display = 'none';
            currentEditingWaybill = null;
        }

        // Function to populate waybill form for editing
        function editWaybill(waybill) {
            if (currentUserPermissions.role !== 'admin' && !currentUserPermissions.canEditTruckWaybills) {
                showMessage('You do not have permission to edit truck waybills.', 'error');
                return;
            }
            currentEditingWaybill = waybill;
            showView('truck-waybill-view');

            waybillNoInput.value = waybill.waybillNo;
            waybillCreatedDateInput.value = waybill.createdDate || ''; // Populate createdDate
            waybillInvoiceNoInput.value = waybill.invoiceNo || '';
            waybillLcNumberInput.value = waybill.lcNumber || '';
            waybillTinNumberInput.value = waybill.tinNumber || '';
            waybillProformaNumberInput.value = waybill.proformaNumber || '';
            waybillProformaDateInput.value = waybill.proformaDate || '';
            waybillNotifyInput.value = waybill.notify || '';
            document.getElementById('waybillConsignee').value = waybill.consignee || '';
            document.getElementById('waybillShipper').value = waybill.shipper || 'HOJAFA AUTO LTD FZE';
            document.getElementById('waybillPortLoading').value = waybill.portLoading || 'DJIBOUTI FREE ZONE';
            document.getElementById('waybillPortDischarge').value = waybill.portDischarge || 'ADDIS ABABA, ETHIOPIA';
            waybillLatestShipmentDateInput.value = waybill.latestShipmentDate || '';
            waybillGoodsCountryOriginInput.value = waybill.goodsCountryOrigin || 'CHINA';
            waybillThirdPartyAgentInput.value = waybill.thirdPartyAgent || '';
            waybillOverallGrossWeightInput.value = waybill.overallGrossWeight.toFixed(2);
            waybillOverallMeasurementInput.value = waybill.overallMeasurement.toFixed(2);
            waybillFreightPayableInput.value = waybill.freightPayable || 'DESTINATION';


            waybillItemsContainer.innerHTML = '';
            waybill.items.forEach(item => addWaybillItemRow(item));
            calculateWaybillOverallTotals();

            submitWaybillBtn.textContent = 'Update Waybill';
            cancelWaybillEditBtn.style.display = 'inline-block';
            generateWaybillPrintButton.style.display = 'inline-block';
            generateWaybillPrintButton.onclick = () => generateWaybillPrintHTML(waybill);
        }


        // Event listener for adding waybill item
        if (addWaybillItemButton) {
            addWaybillItemButton.addEventListener('click', () => addWaybillItemRow());
        }

        // Event listener for truck waybill form submission
        if (truckWaybillForm) {
            truckWaybillForm.addEventListener('submit', (event) => {
                event.preventDefault();

                const waybillNo = waybillNoInput.value.trim();
                const createdDate = waybillCreatedDateInput.value; // Get createdDate
                const invoiceNo = waybillInvoiceNoInput.value.trim();
                const lcNumber = waybillLcNumberInput.value.trim();
                const tinNumber = waybillTinNumberInput.value.trim();
                const proformaNumber = waybillProformaNumberInput.value.trim();
                const proformaDate = waybillProformaDateInput.value.trim();
                const notify = waybillNotifyInput.value.trim();
                const consignee = document.getElementById('waybillConsignee').value.trim();
                const shipper = document.getElementById('waybillShipper').value.trim();
                const portLoading = document.getElementById('waybillPortLoading').value.trim();
                const portDischarge = document.getElementById('waybillPortDischarge').value.trim();
                const latestShipmentDate = document.getElementById('waybillLatestShipmentDate').value.trim();
                const goodsCountryOrigin = document.getElementById('waybillGoodsCountryOrigin').value.trim();
                const thirdPartyAgent = waybillThirdPartyAgentInput.value.trim();
                const overallGrossWeight = parseFloat(waybillOverallGrossWeightInput.value);
                const overallMeasurement = parseFloat(waybillOverallMeasurementInput.value);
                const freightPayable = waybillFreightPayableInput.value.trim();


                const items = [];
                let hasEmptyItemField = false;
                document.querySelectorAll('.waybill-item-row').forEach(row => {
                    const description = row.querySelector('.wb-item-description').value.trim();
                    const qty = parseFloat(row.querySelector('.wb-item-qty').value);
                    const chassisEngineNo = row.querySelector('.wb-item-chassis-engine').value.trim();
                    const grossWeight = parseFloat(row.querySelector('.wb-item-gross-weight').value) || 0;
                    const measurement = parseFloat(row.querySelector('.wb-item-measurement').value) || 0;
                    const manufactureYear = row.querySelector('.wb-item-manufacture-year').value.trim();


                    if (!description || isNaN(qty) || !chassisEngineNo) {
                        hasEmptyItemField = true;
                        return;
                    }
                    items.push({ description, qty, chassisEngineNo, grossWeight, measurement, manufactureYear });
                });

                if (hasEmptyItemField) {
                    showMessage('Please fill in all required fields for waybill items (Description, Qty, Chassis/Engine No.).', 'error');
                    return;
                }
                 if (items.length === 0) {
                     showMessage('Please add at least one item to the waybill.', 'error');
                     return;
                }

                const newWaybillData = {
                    waybillNo,
                    createdDate, // Store createdDate
                    invoiceNo: invoiceNo,
                    lcNumber,
                    tinNumber,
                    proformaNumber,
                    proformaDate,
                    notify,
                    consignee,
                    shipper,
                    portLoading,
                    portDischarge,
                    latestShipmentDate,
                    goodsCountryOrigin,
                    thirdPartyAgent,
                    overallGrossWeight,
                    overallMeasurement,
                    freightPayable,
                    items,
                    timestamp: currentEditingWaybill ? currentEditingWaybill.timestamp : new Date()
                };

                if (currentEditingWaybill) {
                    const index = waybills.findIndex(wb => wb.waybillNo === currentEditingWaybill.waybillNo);
                    if (index !== -1) {
                        waybills[index] = newWaybillData;
                        showMessage(`Waybill ${waybillNo} updated successfully.`);
                    } else {
                        waybills.unshift(newWaybillData);
                        showMessage(`Waybill ${waybillNo} created successfully (as update failed to find original).`);
                    }
                    currentEditingWaybill = null;
                } else {
                    if (waybills.some(wb => wb.waybillNo === waybillNo)) {
                        showMessage(`Waybill No. ${waybillNo} already exists.`, 'error');
                        return;
                    }
                    waybills.unshift(newWaybillData);
                    showMessage(`Waybill ${waybillNo} created successfully.`);
                }

                saveWaybills();
                resetWaybillForm();
                drawWaybills();
                updateDashboard();
                updateCharts();
                generateWaybillPrintButton.style.display = 'inline-block';
                generateWaybillPrintButton.onclick = () => generateWaybillPrintHTML(newWaybillData);
            });
        }

        // Event listener for Waybill Cancel Edit button
        if (cancelWaybillEditBtn) {
            cancelWaybillEditBtn.addEventListener('click', resetWaybillForm);
        }

        // Function to draw waybills table
        function drawWaybills() {
            if (!waybillsTableBody) return;
            waybillsTableBody.innerHTML = '';

            waybills.sort((a, b) => b.timestamp - a.timestamp);

            waybills.forEach((wb, index) => {
                const row = waybillsTableBody.insertRow();
                row.insertCell(0).textContent = wb.waybillNo;
                row.insertCell(1).textContent = wb.invoiceNo || 'N/A';
                row.insertCell(2).textContent = wb.consignee || 'N/A';
                row.insertCell(3).textContent = wb.createdDate || wb.timestamp.toLocaleDateString(); // Display createdDate
                const actionsCell = row.insertCell(4);

                const viewButton = document.createElement('button');
                viewButton.textContent = 'View/Print';
                viewButton.classList.add('generate-doc-btn');
                viewButton.onclick = () => generateWaybillPrintHTML(wb);
                actionsCell.appendChild(viewButton);

                if (currentUserPermissions.role === 'admin' || currentUserPermissions.canEditTruckWaybills) { // Allow edit if admin or has specific permission
                    const editButton = document.createElement('button');
                    editButton.textContent = 'Edit';
                    editButton.classList.add('edit-btn');
                    editButton.onclick = () => editWaybill(wb);
                    actionsCell.appendChild(editButton);
                }

                if (currentUserPermissions.role === 'admin') {
                    const deleteButton = document.createElement('button');
                    deleteButton.textContent = 'Delete';
                    deleteButton.classList.add('delete-btn');
                    deleteButton.onclick = () => showConfirmation(`Are you sure you want to delete Waybill No. ${wb.waybillNo}?`, () => {
                        waybills.splice(index, 1);
                        saveWaybills();
                        drawWaybills();
                        showMessage(`Waybill ${wb.waybillNo} deleted.`);
                        updateDashboard();
                        updateCharts();
                    });
                    actionsCell.appendChild(deleteButton);
                }
            });
        }

        // Function to generate printable waybill HTML (for window.print)
        function generateWaybillPrintHTML(waybill) {
            const printWindow = window.open('', '_blank');
            if (!printWindow) {
                showMessage('Pop-up blocked! Please allow pop-ups for this site to generate the document.', 'error');
                return;
            }
            printWindow.document.write(`
                <html>
                <head>
                    <title>Truck Waybill No. ${waybill.waybillNo}</title>
                    <style>
                        body { font-family: 'Arial', sans-serif; margin: 0; padding: 0; color: #333; font-size: 9pt; } /* Reduced base font size */
                        .document-print-container { width: 210mm; min-height: 297mm; margin: 0 auto; padding: 8mm 12mm; box-sizing: border-box; color: #000; font-size: 9pt; }
                        .header { text-align: center; margin-bottom: 6mm; }
                        .header p:first-child { color: #003366; font-size: 1.1em; font-weight: bold; margin-bottom: 1.5mm; }
                        .header p { color: #333; font-size: 0.8em; margin: 0.4mm 0; }
                        .header h1 { color: #003366; font-size: 1.6em; margin: 4mm 0 3mm 0; text-transform: uppercase; border-bottom: 2px solid #003366; padding-bottom: 2.5mm; }
                        .header strong { font-size: 1em; }

                        .details-grid {
                            display: grid;
                            grid-template-columns: 1fr 1fr;
                            gap: 2.5mm 5mm; /* Reduced gap */
                            margin-bottom: 5mm; /* Reduced margin */
                            font-size: 0.85em; /* Reduced */
                        }
                        .details-grid strong { display: block; margin-bottom: 1mm; color: #003366; font-size: 0.95em; }
                        .details-item { border: 1px solid #c0c0c0; padding: 2.5mm 4mm; border-radius: 3px; background-color: #fcfcfc; box-sizing: border-box; }
                        .details-item span { display: block; line-height: 1.3; }

                        .item-table { width: 100%; border-collapse: collapse; margin-top: 5mm; font-size: 0.85em; }
                        .item-table th, .item-table td { border: 1px solid #999; padding: 3mm; text-align: left; }
                        .item-table th { background-color: #0056b3; color: white; font-weight: bold; }
                        .item-table tbody tr:nth-child(even) { background-color: #f0f0f0; }
                        .item-table tbody tr:nth-child(odd) { background-color: #ffffff; }
                        .item-table td.right-align { text-align: right; }
                        .item-table td:nth-child(1) { width: 35%; font-weight: bold; } /* Description of Goods N/M */
                        .item-table td:nth-child(3) { width: 25%; font-weight: bold; } /* CHASSIS NO./ENGINE NO. */

                        .footer { margin-top: 10mm; text-align: center; font-size: 0.75em; color: #555; }
                        @page { size: A4; margin: 0; }
                    </style>
                </head>
                <body>
                    <div class="document-print-container">
                        <div class="header">
                            <p>HOJAFA AUTO LTD FZE</p>
                            <p>Tel:+25377828674/+251912617438 Email; hojafaautoltdfze@gmail.com</p>
                            <p>UKAB FREE ZONE (FZE), REPUBLIC OF DJIBOUTI.</p>
                            <h1>TRUCK WAY BILL</h1>
                            <p><strong>TWB NO:</strong> ${waybill.waybillNo}</p>
                            <p><strong>DATE:</strong> ${waybill.createdDate || new Date(waybill.timestamp).toLocaleDateString()}</p>
                            <p><strong>ASSOCIATED INVOICE NO:</strong> ${waybill.invoiceNo || 'N/A'}</p>
                        </div>

                        <div class="details-grid">
                            <div class="details-item">
                                <strong>LC NUMBER:</strong>
                                <span>${waybill.lcNumber || ''}</span>
                            </div>
                            <div class="details-item">
                                <strong>TIN NUMBER:</strong>
                                <span>${waybill.tinNumber || ''}</span>
                            </div>
                            <div class="details-item">
                                <strong>PROFORMA NUMBER:</strong>
                                <span>${waybill.proformaNumber || ''}</span>
                            </div>
                            <div class="details-item">
                                <strong>DATE OF PROFORMA:</strong>
                                <span>${waybill.proformaDate || ''}</span>
                            </div>
                            <div class="details-item">
                                <strong>CONSIGNEE:</strong>
                                <span>${waybill.consignee || ''}</span>
                            </div>
                            <div class="details-item">
                                <strong>NOTIFY:</strong>
                                <span>${waybill.notify || ''}</span>
                            </div>
                            <div class="details-item">
                                <strong>SHIPPER (SENDER):</strong>
                                <span>${waybill.shipper || 'HOJAFA AUTO LTD FZE'}</span>
                            </div>
                            <div class="details-item">
                                <strong>Port of Loading/Airport of Dep:</strong>
                                <span>${waybill.portLoading || 'DJIBOUTI FREE ZONE'}</span>
                            </div>
                            <div class="details-item">
                                <strong>Port of Discharge/Airport of Dest:</strong>
                                <span>${waybill.portDischarge || 'ADDIS ABABA, ETHIOPIA'}</span>
                            </div>
                            <div class="details-item">
                                <strong>SHIPMENT:</strong>
                                <span>SELF DRIVE</span>
                            </div>
                            <div class="details-item">
                                <strong>Latest Date of Shipment:</strong>
                                <span>${waybill.latestShipmentDate || ''}</span>
                            </div>
                            <div class="details-item">
                                <strong>GOODS COUNTRY OF ORIGIN:</strong>
                                <span>${waybill.goodsCountryOrigin || 'CHINA'}</span>
                            </div>
                            <div class="details-item">
                                <strong>THIRD PARTY or ITS agent:</strong>
                                <span>${waybill.thirdPartyAgent || ''}</span>
                            </div>
                        </div>

                        <table class="item-table">
                            <thead>
                                <tr>
                                    <th>Description of Goods N/M</th>
                                    <th>QTY (UNITS)</th>
                                    <th>CHASSIS NO./ENGINE NO.</th>
                                    <th>Manufacture Year</th>
                                    <th>TOTAL GROSS WEIGHT (KGS)</th>
                                    <th>TOTAL MEASUREMENT (CBM)</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${waybill.items.map(item => `
                                    <tr>
                                        <td>${item.description}</td>
                                        <td>${item.qty}</td>
                                        <td>${item.chassisEngineNo}</td>
                                        <td>${item.manufactureYear || ''}</td>
                                        <td>${item.grossWeight.toFixed(2)}</td>
                                        <td>${item.measurement.toFixed(2)}</td>
                                    </tr>
                                `).join('')}
                                <tr>
                                    <td colspan="4" class="right-align"></td>
                                    <td><strong>TOTAL GROSS WEIGHT:</strong> ${waybill.overallGrossWeight.toFixed(2)} KG</td>
                                    <td><strong>TOTAL MEASUREMENT:</strong> ${waybill.overallMeasurement.toFixed(2)} CBM</td>
                                </tr>
                                <tr>
                                    <td colspan="6" class="right-align">FREIGHT PAYABLE AT ${waybill.freightPayable || 'DESTINATION'}</td>
                                </tr>
                            </tbody>
                        </table>

                        <div class="footer">
                            <p>ISSUED BY: HOJAFA AUTO LTD FZE</p>
                            <p>Date: ${waybill.createdDate || new Date(waybill.timestamp).toLocaleDateString()}</p>
                        </div>
                    </div>
                </body>
                </html>
            `);
            printWindow.document.close();
            printWindow.print();
        }
        if (generateWaybillPrintButton) {
            generateWaybillPrintButton.addEventListener('click', () => {
                generateWaybillPrintHTML(waybills[0]);
            });
        }
        // Initial setup for waybill item row and overall totals
        addWaybillItemRow();
        calculateWaybillOverallTotals();

        // --- NEW: Export/Import for Truck Waybill ---
        document.getElementById('exportWaybillToExcel')?.addEventListener('click', () => {
            const waybillNo = document.getElementById('waybillNo').value;
            const createdDate = document.getElementById('waybillCreatedDate').value; // Export createdDate
            const invoiceNo = document.getElementById('waybillInvoiceNo').value;
            const lcNumber = document.getElementById('waybillLcNumber').value;
            const tinNumber = document.getElementById('waybillTinNumber').value;
            const proformaNumber = document.getElementById('waybillProformaNumber').value;
            const proformaDate = document.getElementById('waybillProformaDate').value;
            const notify = document.getElementById('waybillNotify').value;
            const consignee = document.getElementById('waybillConsignee').value;
            const shipper = document.getElementById('waybillShipper').value;
            const portLoading = document.getElementById('waybillPortLoading').value;
            const portDischarge = document.getElementById('waybillPortDischarge').value;
            const latestShipmentDate = document.getElementById('waybillLatestShipmentDate').value;
            const goodsCountryOrigin = document.getElementById('waybillGoodsCountryOrigin').value;
            const thirdPartyAgent = document.getElementById('waybillThirdPartyAgent').value;
            const overallGrossWeight = document.getElementById('waybillOverallGrossWeight').value;
            const overallMeasurement = document.getElementById('waybillOverallMeasurement').value;
            const freightPayable = document.getElementById('waybillFreightPayable').value;

            const waybillItems = [];
            document.querySelectorAll('.waybill-item-row').forEach(row => {
                const description = row.querySelector('.wb-item-description')?.value || '';
                const qty = row.querySelector('.wb-item-qty')?.value || '';
                const chassisEngineNo = row.querySelector('.wb-item-chassis-engine')?.value || '';
                const grossWeight = row.querySelector('.wb-item-gross-weight')?.value || '';
                const measurement = row.querySelector('.wb-item-measurement')?.value || '';
                const manufactureYear = row.querySelector('.wb-item-manufacture-year')?.value || '';
                waybillItems.push([description, qty, chassisEngineNo, manufactureYear, grossWeight, measurement]);
            });

            const headerDetails = [
                ["Waybill No", waybillNo],
                ["Created Documents Date", createdDate], // Export createdDate
                ["Associated Invoice No", invoiceNo],
                ["LC Number", lcNumber],
                ["TIN Number", tinNumber],
                ["Proforma Number", proformaNumber],
                ["Date of Proforma", proformaDate],
                ["Notify", notify],
                ["Consignee", consignee],
                ["Shipper (Sender)", shipper],
                ["Port of Loading/Departure", portLoading],
                ["Port of Discharge/Destination", portDischarge],
                ["Latest Date of Shipment", latestShipmentDate],
                ["Goods Country of Origin", goodsCountryOrigin],
                ["THIRD PARTY or ITS agent", thirdPartyAgent],
                ["Overall Gross Weight (KGS)", overallGrossWeight],
                ["Overall Measurement (CBM)", overallMeasurement],
                ["Freight Payable At", freightPayable]
            ];

            const itemHeaders = ["Description of Goods N/M", "QTY (UNITS)", "CHASSIS NO./ENGINE NO.", "Manufacture Year", "TOTAL GROSS WEIGHT (KGS)", "TOTAL MEASUREMENT (CBM)"];

            const ws_data = [
                ["Truck Waybill Details"],
                [], // Spacer
                ...headerDetails,
                [], // Spacer
                ["Items for Shipment"],
                itemHeaders,
                ...waybillItems
            ];

            const wb = XLSX.utils.book_new();
            const ws = XLSX.utils.aoa_to_sheet(ws_data);
            XLSX.utils.book_append_sheet(wb, ws, "Truck Waybill");

            XLSX.writeFile(wb, `Truck_Waybill_${waybillNo || 'No'}.xlsx`);
            showMessage('Truck Waybill data exported to Excel!', 'success');
        });

        document.getElementById('importWaybillExcel')?.addEventListener('change', (event) => {
            const file = event.target.files[0];
            if (!file) {
                return;
            }

            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    const sheetName = workbook.SheetNames[0];
                    const worksheet = workbook.Sheets[sheetName];
                    const json = XLSX.utils.sheet_to_json(worksheet, { header: 1 });

                    if (json.length < 20) { // Minimum rows for header + 1 item
                        showMessage('Invalid Excel file for Truck Waybill. Expected at least header and one item row.', 'error');
                        event.target.value = null;
                        return;
                    }

                    resetWaybillForm(); // This will also generate a new Waybill number

                    const headerMap = new Map(json.slice(2, 20)); // Rows 2 to 19 contain header key-value pairs (adjusted for new date field)

                    waybillCreatedDateInput.value = headerMap.get("Created Documents Date") || ''; // Import createdDate
                    waybillInvoiceNoInput.value = headerMap.get("Associated Invoice No") || '';
                    waybillLcNumberInput.value = headerMap.get("LC Number") || '';
                    waybillTinNumberInput.value = headerMap.get("TIN Number") || '';
                    waybillProformaNumberInput.value = headerMap.get("Proforma Number") || '';
                    waybillProformaDateInput.value = headerMap.get("Date of Proforma") || '';
                    waybillNotifyInput.value = headerMap.get("Notify") || '';
                    document.getElementById('waybillConsignee').value = headerMap.get("Consignee") || '';
                    document.getElementById('waybillShipper').value = headerMap.get("Shipper (Sender)") || 'HOJAFA AUTO LTD FZE';
                    document.getElementById('waybillPortLoading').value = headerMap.get("Port of Loading/Departure") || 'DJIBOUTI FREE ZONE';
                    document.getElementById('waybillPortDischarge').value = headerMap.get("Port of Discharge/Destination") || 'ADDIS ABABA, ETHIOPIA';
                    waybillLatestShipmentDateInput.value = headerMap.get("Latest Date of Shipment") || '';
                    waybillGoodsCountryOriginInput.value = headerMap.get("Goods Country of Origin") || 'CHINA';
                    waybillThirdPartyAgentInput.value = headerMap.get("THIRD PARTY or ITS agent") || '';
                    waybillFreightPayableInput.value = headerMap.get("Freight Payable At") || 'DESTINATION';

                    waybillItemsContainer.innerHTML = '';

                    const itemStartIndex = json.findIndex(row => row[0] === "Items for Shipment") + 2;
                    if (itemStartIndex > 0) {
                        for (let i = itemStartIndex; i < json.length; i++) {
                            const itemData = json[i];
                            if (itemData.length >= 6) {
                                addWaybillItemRow({
                                    description: itemData[0],
                                    qty: parseFloat(itemData[1]),
                                    chassisEngineNo: itemData[2],
                                    manufactureYear: itemData[3],
                                    grossWeight: parseFloat(itemData[4]),
                                    measurement: parseFloat(itemData[5])
                                });
                            }
                        }
                    }
                    calculateWaybillOverallTotals(); // Recalculate totals after import
                    showMessage('Truck Waybill data imported successfully!', 'success');
                } catch (e) {
                    showMessage('Error importing Truck Waybill Excel file. Please ensure it matches the expected format.', 'error');
                    console.error('Error importing Truck Waybill Excel:', e);
                } finally {
                    event.target.value = null;
                }
            };
            reader.readAsArrayBuffer(file);
        });


        // --- Document Archive Functions --- /* NEW SECTION */

        // Resets the archive document form
        function resetArchiveDocumentForm() {
            archiveDocumentForm.reset();
            archiveFileNameSpan.textContent = 'No file chosen';
            archiveDocFileInput.value = ''; // Clear the file input
        }

        // Handles file input change for document archive
        if (archiveDocFileInput) {
            archiveDocFileInput.addEventListener('change', (event) => {
                const fileName = event.target.files[0] ? event.target.files[0].name : 'No file chosen';
                archiveFileNameSpan.textContent = fileName;
            });
        }

        // Handles archive document form submission
        if (archiveDocumentForm) {
            archiveDocumentForm.addEventListener('submit', (event) => {
                event.preventDefault();

                const docName = archiveDocNameInput.value.trim();
                const docCategory = archiveDocCategoryInput.value.trim();
                const docAssociatedRef = archiveDocAssociatedRefInput.value.trim();
                const file = archiveDocFileInput.files[0];

                if (!docName || !file) {
                    showMessage('Please provide a Document Name and select a file to archive.', 'error');
                    return;
                }

                // For security reasons, browsers do not allow direct access to local file paths.
                // We cannot store the file on "Disk D" or create folders.
                // We will store metadata and provide a download link for the original file.
                // The actual file content is NOT stored in localStorage due to size limitations.

                const reader = new FileReader();
                reader.onload = (e) => {
                    const newDocument = {
                        id: Date.now(), // Simple unique ID
                        docName: docName,
                        category: docCategory,
                        associatedRef: docAssociatedRef,
                        fileName: file.name,
                        fileType: file.type,
                        fileSize: file.size,
                        uploadDate: new Date(),
                        // Storing base64 for small files is possible but not recommended for large files
                        // For large files, you would need a backend server to store them.
                        // For this demo, we will store a data URL for small files to allow download.
                        fileDataUrl: e.target.result // Base64 encoded data URL
                    };

                    archivedDocuments.unshift(newDocument);
                    saveArchivedDocuments();
                    showMessage(`Document "${docName}" archived successfully (metadata stored).`);
                    resetArchiveDocumentForm();
                    drawArchivedDocuments();
                    updateDashboard();
                };
                reader.onerror = () => {
                    showMessage('Error reading file. Please try again.', 'error');
                };
                reader.readAsDataURL(file); // Read file as Data URL (base64)
            });
        }

        // Draws the archived documents table
        function drawArchivedDocuments() {
            if (!archivedDocumentsTableBody) return;
            archivedDocumentsTableBody.innerHTML = '';

            archivedDocuments.sort((a, b) => b.uploadDate - a.uploadDate);

            archivedDocuments.forEach((doc, index) => {
                const row = archivedDocumentsTableBody.insertRow();
                row.insertCell(0).textContent = doc.docName;
                row.insertCell(1).textContent = doc.category || 'N/A';
                row.insertCell(2).textContent = doc.associatedRef || 'N/A';
                row.insertCell(3).textContent = doc.fileName;
                row.insertCell(4).textContent = doc.uploadDate.toLocaleDateString();
                const actionsCell = row.insertCell(5);

                const downloadButton = document.createElement('button');
                downloadButton.textContent = 'Download';
                downloadButton.classList.add('generate-doc-btn'); // Reusing style
                downloadButton.onclick = () => {
                    if (doc.fileDataUrl) {
                        const a = document.createElement('a');
                        a.href = doc.fileDataUrl;
                        a.download = doc.fileName;
                        document.body.appendChild(a);
                        a.click();
                        document.body.removeChild(a);
                        showMessage(`Downloading ${doc.fileName}...`);
                    } else {
                        showMessage('File data not available for download.', 'error');
                    }
                };
                actionsCell.appendChild(downloadButton);

                if (currentUserPermissions.role === 'admin') {
                    const deleteButton = document.createElement('button');
                    deleteButton.textContent = 'Delete';
                    deleteButton.classList.add('delete-btn');
                    deleteButton.onclick = () => showConfirmation(`Are you sure you want to delete archived document "${doc.docName}"?`, () => {
                        archivedDocuments.splice(index, 1);
                        saveArchivedDocuments();
                        drawArchivedDocuments();
                        showMessage(`Document "${doc.docName}" deleted.`);
                        updateDashboard();
                    });
                    actionsCell.appendChild(deleteButton);
                }
            });
        }

        // --- End Document Archive Functions ---


        // --- Dashboard Functions ---
        function updateDashboard() {
            if (!dashboardCheckedIn || !dashboardCheckedOut || !dashboardAvailableChassis || !dashboardInvoices || !dashboardPackingLists || !dashboardWaybills || !dashboardArchivedDocuments || !dashboardRecentActivity) { /* UPDATED */
                console.error("Dashboard elements not found.");
                return;
            }

            const currentInventory = getCurrentInventory();
            const checkedInCount = currentInventory.length;
            dashboardCheckedIn.textContent = checkedInCount;

            const checkedOutCount = transactions.filter(t => t.type === 'check-out').length;
            dashboardCheckedOut.textContent = checkedOutCount;

            const netChassisCount = checkedInCount - checkedOutCount;
            dashboardAvailableChassis.textContent = netChassisCount;

            dashboardInvoices.textContent = invoices.length;
            dashboardPackingLists.textContent = packingLists.length;
            dashboardWaybills.textContent = waybills.length;
            dashboardArchivedDocuments.textContent = archivedDocuments.length; /* NEW */


            dashboardRecentActivity.innerHTML = '';
            const allActivities = [
                ...transactions.map(t => ({ type: `Chassis ${t.type}`, detail: t.chassisNumber, timestamp: t.timestamp })),
                ...invoices.map(inv => ({ type: 'Invoice Created', detail: inv.invoiceNo, timestamp: new Date(inv.createdDate || inv.timestamp) })), // Use createdDate
                ...packingLists.map(pl => ({ type: 'Packing List Created', detail: pl.packingListNo, timestamp: new Date(pl.createdDate || pl.timestamp) })), // Use createdDate
                ...waybills.map(wb => ({ type: 'Waybill Created', detail: wb.waybillNo, timestamp: new Date(wb.createdDate || wb.timestamp) })), // Use createdDate
                ...archivedDocuments.map(doc => ({ type: 'Document Archived', detail: doc.fileName, timestamp: doc.uploadDate })) /* NEW */
            ];

            allActivities.sort((a, b) => b.timestamp - a.timestamp);
            const recentActivities = allActivities.slice(0, 5);

            if (recentActivities.length === 0) {
                const li = document.createElement('li');
                li.textContent = 'No recent activity.';
                dashboardRecentActivity.appendChild(li);
            } else {
                recentActivities.forEach(activity => {
                    const li = document.createElement('li');
                    li.textContent = `${activity.timestamp.toLocaleDateString()} - ${activity.type}: ${activity.detail}`;
                    dashboardRecentActivity.appendChild(li);
                });
            }
        }

        // --- Chart.js Functions ---
        function updateCharts() {
            const checkedInCount = getCurrentInventory().length;
            const checkedOutCount = transactions.filter(t => t.type === 'check-out').length;

            const chassisStatusData = {
                labels: ['Checked In', 'Checked Out'],
                datasets: [{
                    label: 'Chassis Status',
                    data: [checkedInCount, checkedOutCount],
                    backgroundColor: [
                        'rgba(80, 250, 123, 0.8)', /* Green for Checked In */
                        'rgba(255, 85, 85, 0.8)'  /* Red for Checked Out */
                    ],
                    borderColor: [
                        'rgba(80, 250, 123, 1)',
                        'rgba(255, 85, 85, 1)'
                    ],
                    borderWidth: 1
                }]
            };

            const chassisStatusOptions = {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    title: {
                        display: true,
                        text: 'Chassis Status (In vs. Out)',
                        color: 'var(--text-dark)' /* Light text for title */
                    },
                    legend: {
                        labels: {
                            color: 'var(--text-dark)' /* Light text for legend */
                        }
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: {
                            color: 'var(--text-muted)' /* Light blue for ticks */
                        },
                        grid: {
                            color: 'rgba(0, 0, 0, 0.1)' /* Faded grid lines */
                        }
                    },
                    x: {
                        ticks: {
                            color: 'var(--text-muted)'
                        },
                        grid: {
                            color: 'rgba(0, 0, 0, 0.1)'
                        }
                    }
                }
            };

            const chassisStatusCtx = document.getElementById('chassisStatusChart');
            if (chassisStatusCtx) {
                if (chassisStatusChartInstance) {
                    chassisStatusChartInstance.destroy();
                }
                chassisStatusChartInstance = new Chart(chassisStatusCtx, {
                    type: 'bar',
                    data: chassisStatusData,
                    options: chassisStatusOptions
                });
            }

            const documentTypeData = {
                labels: ['Invoices', 'Packing Lists', 'Waybills', 'Archived Docs'], /* UPDATED */
                datasets: [{
                    data: [invoices.length, packingLists.length, waybills.length, archivedDocuments.length], /* UPDATED */
                    backgroundColor: [
                        'rgba(0, 123, 255, 0.8)', /* Light blue for Invoices */
                        'rgba(255, 193, 7, 0.8)',  /* Orange for Packing Lists */
                        'rgba(40, 167, 69, 0.8)',   /* Green for Waybills */
                        'rgba(108, 117, 125, 0.8)' /* Grey for Archived Docs */ /* NEW */
                    ],
                    borderColor: [
                        'rgba(0, 123, 255, 1)',
                        'rgba(255, 193, 7, 1)',
                        'rgba(40, 167, 69, 1)',
                        'rgba(108, 117, 125, 1)' /* NEW */
                    ],
                    borderWidth: 1
                }]
            };

            const documentTypeOptions = {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    title: {
                        display: true,
                        text: 'Documents Generated',
                        color: 'var(--text-dark)'
                    },
                    legend: {
                        position: 'top',
                        labels: {
                            color: 'var(--text-dark)'
                        }
                    }
                }
            };

            const documentTypeCtx = document.getElementById('documentTypeChart');
            if (documentTypeCtx) {
                if (documentTypeChartInstance) {
                    documentTypeChartInstance.destroy();
                }
                documentTypeChartInstance = new Chart(documentTypeCtx, {
                    type: 'pie',
                    data: documentTypeData,
                    options: documentTypeOptions
                });
            }
        }

        // NEW: Function to update the yard summary in the history view
        function updateHistoryYardSummary() {
            if (historyInYardCount) {
                const currentInventoryCount = getCurrentInventory().length;
                historyInYardCount.textContent = currentInventoryCount;
            }
        }

        // NEW: Event listener for the "View Inventory Yard" link in history
        if (viewInventoryLink) {
            viewInventoryLink.addEventListener('click', (event) => {
                event.preventDefault();
                showView('inventory-view');
            });
        }

        // Initial setup: Show the login view by default
        loginContainer.style.display = 'flex';
        appWrapper.style.display = 'none'; // Hide appWrapper initially
        updateUIBasedOnRole();
    </script>
</body>
</html>